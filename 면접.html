<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©´ì ‘ ê¸°ì¶œ ë¦¬í¬íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* ê¸°ë³¸ ì›¹ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Pretendard', 'Noto Sans KR', sans-serif; background: #f4f6f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; align-items: flex-start; }
        .viewer-section { flex: 2; background: #525659; padding: 20px; border-radius: 8px; overflow-y: auto; max-height: 90vh; }
        
        /* --- A4 PDF ì˜ì—­ ìŠ¤íƒ€ì¼ --- */
        #pdf-content {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 0; 
            box-sizing: border-box;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        /* --- í—¤ë”/í‘¸í„° ì´ë¯¸ì§€ ì˜ì—­ --- */
        .pdf-brand-header, .pdf-brand-footer {
            background-color: #000;
            text-align: center;
            padding: 15px 0;
            width: 100%;
            display: block; 
        }
        .pdf-brand-header img, .pdf-brand-footer img {
            max-width: 90%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        /* --- ë³¸ë¬¸ ì»¨í…ì¸  ì˜ì—­ --- */
        .report-body-container {
            flex: 1;
            padding: 20mm;
        }
        
        .report-header { text-align: center; border-bottom: 2px solid #2c3e50; padding-bottom: 20px; margin-bottom: 30px; }
        .report-title { font-size: 24pt; font-weight: bold; color: #2c3e50; margin: 0; }
        .report-date { font-size: 10pt; color: #7f8c8d; margin-top: 10px; }
        .org-section { margin-bottom: 30px; page-break-inside: avoid; }
        .org-title { font-size: 16pt; font-weight: bold; color: #1a5276; border-left: 5px solid #1a5276; padding-left: 10px; margin-bottom: 15px; background: #eaf2f8; padding-top:5px; padding-bottom: 5px; }
        .date-block { margin-left: 15px; margin-bottom: 20px; border-left: 2px solid #ddd; padding-left: 15px; }
        .date-label { font-size: 11pt; font-weight: bold; color: #555; margin-bottom: 10px; display: inline-block; background: #f8f9fa; padding: 2px 8px; border-radius: 4px; }
        .q-list { list-style: none; padding: 0; margin: 0; }
        .q-item { margin-bottom: 12px; }
        .q-text { font-size: 11pt; font-weight: 600; line-height: 1.5; color: #333; }
        .q-note { font-size: 9pt; color: #666; margin-top: 4px; background: #fffbe6; padding: 5px 10px; border-radius: 4px; display: inline-block; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .control-section { flex: 1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        label { font-weight: bold; display: block; margin-top: 10px; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; } /* box-sizing ì¶”ê°€ */
        textarea { resize: vertical; height: 80px; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; }
        .btn-search { background: #3498db; color: white; flex: 1; }
        .btn-save { background: #2c3e50; color: white; margin-top: 15px; }
        .btn-pdf { background: #e74c3c; color: white; margin-top: 20px; font-size: 1.1rem; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button:hover { opacity: 0.9; }
    </style>
</head>
<body>

<div class="container">
    <div class="viewer-section">
        <div id="pdf-content">
            
            <div class="pdf-brand-header">
                <img src="sorizava_header_logo.png" alt="SORIZAVA ACADEMY Header">
            </div>

            <div class="report-body-container">
                <div class="report-header">
                    <h1 class="report-title">ë©´ì ‘ ê¸°ì¶œ ìë£Œì§‘</h1>
                    <div class="report-date" id="printDate"></div>
                </div>
                <div id="reportBody">
                    <p style="text-align:center; color:#999; padding-top:100px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>

            <div class="pdf-brand-footer">
                <img src="sorizava_footer_char.png" alt="SORIZAVA ACADEMY Footer">
            </div>

        </div>
    </div>

    <div class="control-section">
        <h2>ğŸ” ê²€ìƒ‰ ë° í•„í„°</h2>
        <input type="text" id="searchInput" placeholder="ê¸°ê´€ëª… ë˜ëŠ” ì§ˆë¬¸ ë‚´ìš© ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){searchData()}">
        <div class="btn-group">
            <button class="btn-search" onclick="searchData()">ê²€ìƒ‰ ì ìš©</button>
        </div>
        <button class="btn-pdf" onclick="downloadPDF()">ğŸ“„ PDFë¡œ ë‚´ë ¤ë°›ê¸°</button>
        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
        <h2>ğŸ“ ë°ì´í„° ì¶”ê°€</h2>
        <form id="uploadForm">
            <label>ë©´ì ‘ ë‚ ì§œ</label>
            <input type="date" id="inDate" required>
            <label>ê¸°ê´€ëª…</label>
            <input type="text" id="inOrg" placeholder="ì˜ˆ: í•œêµ­ì „ë ¥ê³µì‚¬" required>
            <label>ë©´ì ‘ ì§ˆë¬¸</label>
            <textarea id="inQ" placeholder="ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
            <label>ë¹„ê³  (ë‹µë³€ í¬ì¸íŠ¸ ë“±)</label>
            <input type="text" id="inNote" placeholder="ì§§ì€ ë©”ëª¨">
            <button type="button" class="btn-save" onclick="submitData()">ìë£Œ ì €ì¥í•˜ê¸°</button>
        </form>
    </div>
</div>

<script>
    // âš ï¸ ë°°í¬ëœ Google Apps Script URL
    const API_URL = "https://script.google.com/macros/s/AKfycbw08-tGoRXWSxRGdiT1UaoiEqtqhg7dWKynSBtkhH8gWD-sRNy4KSA5FT7GFbnjAtRU/exec"; 

    let allData = [];

    window.onload = function() {
        document.getElementById('inDate').valueAsDate = new Date();
        document.getElementById('printDate').innerText = "ìƒì„±ì¼: " + new Date().toLocaleDateString();
        loadData();
    };

    async function loadData() {
        try {
            const response = await fetch(API_URL);
            allData = await response.json();
            
            // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            allData.sort((a, b) => {
                if (a['ê¸°ê´€ëª…'] < b['ê¸°ê´€ëª…']) return -1;
                if (a['ê¸°ê´€ëª…'] > b['ê¸°ê´€ëª…']) return 1;
                return new Date(b['ë‚ ì§œ']) - new Date(a['ë‚ ì§œ']);
            });
            renderReport(allData);
        } catch (error) {
            console.error(error);
            alert("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    function renderReport(data) {
        const container = document.getElementById('reportBody');
        if (!data || data.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding-top:50px;'>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }
        const grouped = {};
        data.forEach(item => {
            const org = item['ê¸°ê´€ëª…'] || 'ê¸°íƒ€ ê¸°ê´€';
            let date = item['ë‚ ì§œ'] ? String(item['ë‚ ì§œ']).substring(0, 10) : 'ë‚ ì§œ ë¯¸ìƒ';
            if (!grouped[org]) grouped[org] = {};
            if (!grouped[org][date]) grouped[org][date] = [];
            grouped[org][date].push(item);
        });

        let html = "";
        for (const [org, dates] of Object.entries(grouped)) {
            html += `<div class="org-section"><div class="org-title">${org}</div>`;
            for (const [date, items] of Object.entries(dates)) {
                html += `<div class="date-block"><div class="date-label">ğŸ“… ${date}</div><ul class="q-list">`;
                items.forEach(q => {
                    html += `<li class="q-item"><div class="q-text">Q. ${q['ë©´ì ‘ì§ˆë¬¸']}</div>${q['ë¹„ê³ '] ? `<div class="q-note">ğŸ’¡ ${q['ë¹„ê³ ']}</div>` : ''}</li>`;
                });
                html += `</ul></div>`;
            }
            html += `</div>`;
        }
        container.innerHTML = html;
    }

    function searchData() {
        // ê²€ìƒ‰ì–´ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
        const searchInput = document.getElementById('searchInput');
        const keyword = searchInput.value.toLowerCase().trim();
        
        if(!allData || allData.length === 0) {
            alert("ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const filtered = allData.filter(item => {
            const org = item['ê¸°ê´€ëª…'] ? String(item['ê¸°ê´€ëª…']).toLowerCase() : "";
            const q = item['ë©´ì ‘ì§ˆë¬¸'] ? String(item['ë©´ì ‘ì§ˆë¬¸']).toLowerCase() : "";
            return org.includes(keyword) || q.includes(keyword);
        });
        
        renderReport(filtered);
    }

    function submitData() {
        const btn = document.querySelector('.btn-save');
        btn.textContent = "ì €ì¥ ì¤‘...";
        btn.disabled = true;

        const dateVal = document.getElementById('inDate').value;
        const orgVal = document.getElementById('inOrg').value;
        const qVal = document.getElementById('inQ').value;

        if(!dateVal || !orgVal || !qVal) {
            alert("ë‚ ì§œ, ê¸°ê´€ëª…, ì§ˆë¬¸ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
            btn.textContent = "ìë£Œ ì €ì¥í•˜ê¸°";
            btn.disabled = false;
            return;
        }

        const newData = {
            date: dateVal,
            org: orgVal,
            question: qVal,
            note: document.getElementById('inNote').value
        };

        // POST ìš”ì²­ ì „ì†¡ ì‹œ no-cors ëª¨ë“œ ê³ ë ¤ (Apps Script ì„¤ì •ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        // í˜„ì¬ ì½”ë“œëŠ” í‘œì¤€ì ì¸ fetch ë°©ì‹ì…ë‹ˆë‹¤.
        fetch(API_URL, { 
            method: 'POST', 
            body: JSON.stringify(newData)
        })
        .then(() => {
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('inQ').value = "";
            document.getElementById('inNote').value = "";
            loadData(); // ì €ì¥ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => {
            console.error(err);
            alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Google Sheet ê¶Œí•œ ë“±ì„ í™•ì¸í•˜ì„¸ìš”)");
        })
        .finally(() => { 
            btn.textContent = "ìë£Œ ì €ì¥í•˜ê¸°"; 
            btn.disabled = false; 
        });
    }

    function downloadPDF() {
        const element = document.getElementById('pdf-content');
        const keyword = document.getElementById('searchInput').value || "ì „ì²´";
        const opt = {
            margin: 0,
            filename: `${keyword}_ë©´ì ‘ìë£Œì§‘.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>