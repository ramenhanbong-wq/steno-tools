<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†ê¸°ìš© í…ìŠ¤íŠ¸ ë³€í™˜ê¸° (ì‹¬í”Œ ë²„ì „)</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #f4f6f8;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        h2 { margin: 0; color: #333; }

        textarea {
            width: 100%;
            height: 250px;
            margin-bottom: 10px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1.6;
            box-sizing: border-box;
            resize: vertical;
        }
        
        .label-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
        }
        label { font-weight: bold; color: #555; font-size: 1.1em; margin: 0;}
        
        /* ê¸€ì ìˆ˜ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .char-count { 
            font-size: 0.9em; 
            color: #27ae60; 
            font-weight: bold; 
            background: #e8f5e9;
            padding: 4px 10px;
            border-radius: 15px;
        }

        button {
            padding: 12px;
            font-size: 15px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: opacity 0.2s;
            color: white;
        }
        button:hover { opacity: 0.9; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .btn-clean { background-color: #e67e22; flex: 1; font-size: 1.1em; }
        .btn-convert { background-color: #2980b9; flex: 1; font-size: 1.1em; }
        .btn-reset { background-color: #95a5a6; width: 100px; padding: 10px;}
        
        .btn-dict-open { background-color: #27ae60; padding: 8px 15px; font-size: 14px;}

        /* ìœ í‹¸ë¦¬í‹° ë²„íŠ¼ ê·¸ë£¹ */
        .utility-bar {
            background: #f1f2f6;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-util { padding: 10px 15px; font-size: 14px; background-color: #34495e; color: white;}
        
        .btn-copy { background-color: #8e44ad; flex-grow: 1; } 
        .btn-save { background-color: #2c3e50; flex-grow: 0.5; }
        

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 25px;
            border-radius: 10px; width: 90%; max-width: 500px;
            position: relative; max-height: 80vh; display: flex; flex-direction: column;
        }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color:#aaa;}
        .dict-form { margin-bottom: 15px; background: #f9f9f9; padding: 15px; border-radius: 5px;}
        .dict-form input { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ddd; box-sizing: border-box;}
        .btn-add { background-color: #27ae60; width: 100%; margin-top: 5px;}
        .dict-list-container { flex-grow: 1; overflow-y: auto; border: 1px solid #eee; margin-bottom: 15px; padding: 5px;}
        .dict-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 10px; font-size: 14px;}
        .btn-delete { background-color: #c0392b; font-size: 12px; padding: 5px 10px; margin-left: 10px;}
        .backup-area { display: flex; gap: 5px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-backup { background-color: #34495e; flex: 1; font-size: 13px; }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>ğŸ“ í…ìŠ¤íŠ¸ ë³€í™˜ê¸°</h2>
        <button class="btn-dict-open" onclick="openModal()">ğŸ“š ë‹¨ì–´ì¥ ê´€ë¦¬</button>
    </div>

    <div class="label-area">
        <label for="inputText">1. ì›ë³¸ í…ìŠ¤íŠ¸</label>
        <span class="char-count" id="inputCount">ìˆœìˆ˜ ê¸€ììˆ˜: 0ì</span>
    </div>
    <textarea id="inputText" placeholder="ì—¬ê¸°ì— í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..." oninput="updateCount('inputText', 'inputCount')"></textarea>

    <div class="btn-group">
        <button class="btn-clean" onclick="runStage1()">1ì°¨ ì •ì œ (íŠ¹ìˆ˜ë¬¸ì ì œê±°)</button>
        <button class="btn-convert" onclick="runStage2()">2ì°¨ ë³€í™˜ (í•œê¸€/ìˆ«ì ë³€í™˜)</button>
        <button class="btn-reset" onclick="resetAll()">ì´ˆê¸°í™”</button>
    </div>

    <div class="label-area">
        <label for="outputText">2. ê²°ê³¼ë¬¼</label>
        <span class="char-count" id="outputCount">ìˆœìˆ˜ ê¸€ììˆ˜: 0ì</span>
    </div>
    
    <div class="utility-bar">
        <button class="btn-util btn-copy" onclick="copyToClipboard()">ğŸ“‹ ê²°ê³¼ ë³µì‚¬í•˜ê¸°</button>
        <button class="btn-util btn-save" onclick="saveTextFile()">ğŸ’¾ .txt íŒŒì¼ ì €ì¥</button>
    </div>

    <textarea id="outputText" placeholder="ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤." oninput="updateCount('outputText', 'outputCount')"></textarea>
</div>

<div id="dictModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3 style="margin-top:0;">ğŸ“š ë‹¨ì–´ì¥ ê´€ë¦¬</h3>
        <div class="dict-form">
            <input type="text" id="newKey" placeholder="ì˜ì–´ (ì˜ˆ: Email)">
            <input type="text" id="newVal" placeholder="í•œê¸€ (ì˜ˆ: ì´ë©”ì¼)">
            <button class="btn-add" onclick="addWord()">ë‹¨ì–´ ì¶”ê°€</button>
        </div>
        <div class="dict-list-container" id="dictList"></div>
        <div class="backup-area">
            <button class="btn-backup" onclick="exportData()">ğŸ’¾ ë°±ì—… ì €ì¥</button>
            <button class="btn-backup" onclick="importData()">ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input type="file" id="fileInput" style="display: none;" onchange="loadFile(this)">
        </div>
    </div>
</div>

<script>
    // --- [1] ìˆœìˆ˜ ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ ---
    function updateCount(id, spanId) {
        const text = document.getElementById(id).value;
        const pureLength = text.replace(/[^a-zA-Z0-9ê°€-í£]/g, "").length;
        document.getElementById(spanId).innerText = "ìˆœìˆ˜ ê¸€ììˆ˜: " + pureLength + "ì";
    }

    // --- [2] ìœ í‹¸ë¦¬í‹° (ë³µì‚¬, ì €ì¥) ---
    function copyToClipboard() {
        const copyText = document.getElementById("outputText");
        if (copyText.value === "") { alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        
        copyText.select();
        document.execCommand("copy");
        
        const btn = document.querySelector('.btn-copy');
        const originalText = btn.innerText;
        btn.innerText = "âœ… ë³µì‚¬ ì™„ë£Œ!";
        btn.style.backgroundColor = "#27ae60";
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.backgroundColor = "#8e44ad";
        }, 1500);
    }

    function saveTextFile() {
        const text = document.getElementById("outputText").value;
        if(text === "") { alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const anchor = document.createElement("a");
        anchor.href = URL.createObjectURL(blob);
        anchor.download = "ì†ê¸°ì—°ìŠµ_ë³€í™˜ê²°ê³¼.txt";
        anchor.click();
        URL.revokeObjectURL(anchor.href);
    }

    // --- [3] ëª¨ë‹¬ ë° ë‹¨ì–´ì¥ ---
    const modal = document.getElementById("dictModal");
    function openModal() { modal.style.display = "block"; renderDictList(); document.getElementById('newKey').focus(); }
    function closeModal() { modal.style.display = "none"; }
    window.onclick = function(e) { if(e.target == modal) closeModal(); }

    const defaultDict = { "OECD": "ì˜¤ì´ì‹œë””", "Email": "ì´ë©”ì¼", "email": "ì´ë©”ì¼" };
    let myDict = JSON.parse(localStorage.getItem("stenoDict")) || defaultDict;

    function addWord() {
        const key = document.getElementById('newKey').value.trim();
        const val = document.getElementById('newVal').value.trim();
        if (!key || !val) { alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
        myDict[key] = val; saveToStorage();
        document.getElementById('newKey').value = ""; document.getElementById('newVal').value = "";
        renderDictList(); document.getElementById('newKey').focus();
    }
    function deleteWord(key) {
        if(confirm(`'${key}' ì‚­ì œí•©ë‹ˆê¹Œ?`)) { delete myDict[key]; saveToStorage(); renderDictList(); }
    }
    function saveToStorage() { localStorage.setItem("stenoDict", JSON.stringify(myDict)); }
    function renderDictList() {
        const listDiv = document.getElementById('dictList'); listDiv.innerHTML = "";
        const keys = Object.keys(myDict).sort();
        if (keys.length === 0) { listDiv.innerHTML = "<div style='text-align:center;color:#999;padding:20px;'>ë‹¨ì–´ ì—†ìŒ</div>"; return; }
        keys.forEach(key => {
            const item = document.createElement('div'); item.className = 'dict-item';
            item.innerHTML = `<span><b>${key}</b> â†’ ${myDict[key]}</span><button class="btn-delete" onclick="deleteWord('${key}')">ì‚­ì œ</button>`;
            listDiv.appendChild(item);
        });
    }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(myDict));
        const a = document.createElement('a'); a.href = dataStr; a.download = "my_steno_dict.json";
        document.body.appendChild(a); a.click(); a.remove();
    }
    function importData() { document.getElementById('fileInput').click(); }
    function loadFile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { myDict = { ...myDict, ...JSON.parse(e.target.result) }; saveToStorage(); renderDictList(); alert("ë³µêµ¬ ì™„ë£Œ!"); }
            catch(err) { alert("íŒŒì¼ ì˜¤ë¥˜"); }
        }; reader.readAsText(file); input.value = '';
    }

    // --- [4] ë³€í™˜ ë¡œì§ ---
    const alphabetMap = { 'A':'ì—ì´','B':'ë¹„','C':'ì”¨','D':'ë””','E':'ì´','F':'ì—í”„','G':'ì§€','H':'ì—ì´ì¹˜','I':'ì•„ì´','J':'ì œì´','K':'ì¼€ì´','L':'ì—˜','M':'ì— ','N':'ì—”','O':'ì˜¤','P':'í”¼','Q':'í','R':'ì•Œ','S':'ì—ìŠ¤','T':'í‹°','U':'ìœ ','V':'ë¸Œì´','W':'ë”ë¸”ìœ ','X':'ì—‘ìŠ¤','Y':'ì™€ì´','Z':'ì œíŠ¸'};
    const digitMap = { '0':'ì˜','1':'ì¼','2':'ì´','3':'ì‚¼','4':'ì‚¬','5':'ì˜¤','6':'ìœ¡','7':'ì¹ ','8':'íŒ”','9':'êµ¬'};

    function convertNumberToKorean(numStr) {
        const units = ['','ì‹­','ë°±','ì²œ']; const bigUnits = ['','ë§Œ','ì–µ','ì¡°','ê²½'];
        const numChar = ['ì˜','ì¼','ì´','ì‚¼','ì‚¬','ì˜¤','ìœ¡','ì¹ ','íŒ”','êµ¬'];
        let result = ''; let num = numStr.replace(/,/g,''); let length = num.length;
        for(let i=0; i<length; i++) {
            let n = parseInt(num[i]); let digitPos = length - i - 1;
            let unitIndex = digitPos % 4; let bigUnitIndex = Math.floor(digitPos/4);
            if(n > 0) {
                if(n===1 && unitIndex>0) result += units[unitIndex];
                else result += numChar[n] + units[unitIndex];
            }
            if(unitIndex===0 && bigUnitIndex>0) {
                let chunkStart = Math.max(0, i-3);
                if(parseInt(num.substring(chunkStart, i+1)) > 0) result += bigUnits[bigUnitIndex];
            }
        }
        if(result==='') return 'ì˜'; return result;
    }

    function runStage1() {
        let text = document.getElementById('inputText').value;
        text = text.replace(/\([^)]*\)/g, ""); // ê´„í˜¸ ì œê±°
        text = text.replace(/\n/g, " "); // ì¤„ë°”ê¿ˆ ì œê±°
        text = text.replace(/[^a-zA-Z0-9ê°€-í£\s.,?%]/g, ""); // íŠ¹ìˆ˜ë¬¸ì ì œê±°
        text = text.replace(/\s+/g, " ").trim(); // ê³µë°± ì •ë¦¬
        document.getElementById('outputText').value = text;
        updateCount('outputText', 'outputCount');
    }

    function runStage2() {
        let text = document.getElementById('outputText').value || document.getElementById('inputText').value;
        text = text.replace(/\([^)]*\)/g, "");
        text = text.replace(/6\.25/g, "ìœ¡ì´ì˜¤");

        // ë‹¨ì–´ì¥ ì ìš©
        const sortedKeys = Object.keys(myDict).sort((a,b)=>b.length-a.length);
        for(const eng of sortedKeys) {
            text = text.replace(new RegExp(`\\b${eng}\\b`,'g'), myDict[eng]);
        }
        // ì˜ì–´ ì•½ì–´ (ì•ŒíŒŒë²³ ì½ê¸°)
        text = text.replace(/\b[A-Z]+\b/g, (m) => /[ê°€-í£]/.test(m)?m:[...m].map(c=>alphabetMap[c]||c).join(''));
        // ìˆ«ì ë³€í™˜
        text = text.replace(/([0-9]+)(\.[0-9]+)?/g, (m, p1, p2) => {
            let korInt = convertNumberToKorean(p1);
            let korDec = p2 ? "ì " + [...p2.substring(1)].map(c=>digitMap[c]).join('') : "";
            return korInt + korDec;
        });
        document.getElementById('outputText').value = text;
        updateCount('outputText', 'outputCount');
    }

    function resetAll() {
        document.getElementById('inputText').value = "";
        document.getElementById('outputText').value = "";
        updateCount('inputText', 'inputCount');
        updateCount('outputText', 'outputCount');
    }
</script>

</body>
</html>