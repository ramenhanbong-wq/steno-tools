<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì¹´ë°ë¯¸ ì„±ê³¼ ë¶„ì„ í”„ë¡œ(Pro) - í†µí•© ì™„ì„±íŒ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --bg-cream: #fdfbf7;
            --card-white: #ffffff;
            --pastel-pink: #ffb7b2;
            --pastel-blue: #a2c2ff;
            --pastel-mint: #95e1d3;
            --text-main: #4a4a4a;
            --text-sub: #666666; 
            --border-line: #f0ebeb; 
        }

        body {
            font-family: 'Gowun Dodum', 'Pretendard', sans-serif;
            margin: 0;
            background-color: var(--bg-cream);
            color: var(--text-main);
            padding-top: 90px;
            padding-bottom: 50px;
        }

        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; box-sizing: border-box; z-index: 1000;
            border-bottom: 2px solid #fff0f0;
            box-shadow: 0 4px 15px rgba(230, 210, 200, 0.1); 
        }
        .logo {
            font-size: 1.3rem; color: #4a4a4a; text-decoration: none;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
        }
        .logo i { color: #ff9aa2; font-size: 1.2em; }
        .nav-links { display: flex; gap: 8px; }
        .nav-item {
            text-decoration: none; color: #888; font-weight: 600; padding: 8px 15px;
            border-radius: 20px; transition: all 0.3s;
            display: flex; align-items: center; gap: 6px; font-size: 0.95rem;
        }
        .nav-item:hover, .nav-item.active {
            background-color: #fff0f5; color: #ff6f91; transform: translateY(-2px);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header-box { text-align: center; margin-bottom: 30px; }
        .header-box h1 { font-size: 2rem; color: #4a4a4a; margin-bottom: 10px; letter-spacing: -1px; }

        .goal-wrapper {
            max-width: 800px; margin: 0 auto 30px auto;
            background: #fff; padding: 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0ebeb; text-align: center;
        }
        .goal-input-area { margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .goal-input-area input {
            padding: 8px 15px; border: 1px solid #ddd; border-radius: 10px; 
            font-family: 'Pretendard'; font-size: 1rem; width: 120px; text-align: right;
        }
        .progress-container {
            height: 24px; background-color: #f0f0f0; border-radius: 12px; overflow: hidden; position: relative;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #a2c2ff, #95e1d3);
            width: 0%; transition: width 1s ease-in-out;
            display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;
            color: white; font-weight: bold; font-size: 0.85rem;
        }
        .goal-confetti { position: absolute; right: 10px; top: -20px; font-size: 20px; display: none; }

        .control-bar { 
            display: flex; justify-content: center; gap: 10px; margin-top: 15px; 
            background: white; padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(200, 200, 200, 0.15);
            border: 2px solid #fff0f0;
            max-width: 850px; margin-left: auto; margin-right: auto;
            align-items: center; flex-wrap: wrap;
        }

        .btn-style {
            padding: 10px 20px; border-radius: 30px; 
            font-size: 0.95rem; font-weight: bold; cursor: pointer; border: none; 
            transition: 0.2s; font-family: 'Gowun Dodum', sans-serif;
            display: flex; align-items: center; gap: 6px;
        }
        .upload-btn { background: #f0f4ff; color: #5874ff; }
        .upload-btn:hover { background: #dce7ff; transform: translateY(-2px); }
        .compare-btn { background: #fff0f5; color: #ff6f91; }
        .compare-btn:hover { background: #ffe0ea; transform: translateY(-2px); }
        .report-btn { background: #e0f7fa; color: #0097a7; }
        .report-btn:hover { background: #b2ebf2; transform: translateY(-2px); }
        .reset-btn { background: #f5f5f5; color: #666; }
        .reset-btn:hover { background: #e0e0e0; transform: translateY(-2px); }

        select { 
            padding: 10px 20px; border-radius: 30px; 
            border: 2px solid #f0ebeb; font-size: 1rem; cursor: pointer; outline: none; 
            font-family: 'Gowun Dodum', sans-serif; color: #555; background: #fff;
        }
        select:hover { border-color: #ffb7b2; }

        .section-title { 
            font-size: 1.4rem; font-weight: bold; margin: 50px 0 20px 0; 
            display: flex; align-items: center; gap: 10px; color: #333;
        }
        .section-title::before {
            content: ''; display: block; width: 6px; height: 24px; 
            background: #ffb7b2; border-radius: 3px;
        }

        .card, .trend-card, .heatmap-container, .kpi-card, .insight-card, .conversion-card {
            background: #ffffff; border-radius: 25px; padding: 30px;
            border: 2px solid #f0ebeb; box-shadow: 0 8px 20px rgba(200, 200, 200, 0.1);
            transition: all 0.3s ease; position: relative;
        }
        .card:hover, .trend-card:hover, .kpi-card:hover, .insight-card:hover, .conversion-card:hover {
            border-color: #ffe0e0; box-shadow: 0 15px 30px rgba(255, 183, 178, 0.2);
            transform: translateY(-5px);
        }

        .kpi-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 20px; }
        .kpi-card { text-align: center; cursor: pointer; }
        .kpi-label { font-size: 1.1rem; color: #666; margin-bottom: 10px; }
        .kpi-amount { font-size: 2rem; font-weight: bold; margin: 5px 0; font-family: 'Pretendard'; }
        .total .kpi-amount { color: #8cb6ff; }
        .cancel .kpi-amount { color: #ff9aa2; }

        .insight-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .insight-card { padding: 25px 20px; text-align: center; }
        .insight-label { font-size: 0.95rem; color: #999; margin-bottom: 8px; font-family: 'Pretendard'; }
        .insight-value { font-size: 1.7rem; font-weight: bold; color: #4a4a4a; margin-bottom: 8px; font-family: 'Pretendard'; }
        .insight-desc { font-size: 0.85rem; color: #666; font-family: 'Gowun Dodum'; }
        .insight-card.danger { border: 2px solid #ffcfce; background: #fffafa; }
        .badge-re { background: #eef2ff; color: #5874ff; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; display: inline-block; margin-top: 5px; }

        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-top: 15px; }
        th { background: #fff8f8; color: #666; padding: 12px; text-align: left; border-bottom: 2px solid #ffebeb; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; color: #555; }
        tr:hover td { background: #fffcfc; }
        .clickable-row { cursor: pointer; color: #8cb6ff; font-weight: bold; text-decoration: none; }
        .clickable-row:hover { text-decoration: underline; }

        .heatmap-container { overflow-x: auto; padding: 20px; }
        .heatmap-table { width: 100%; border-collapse: separate; border-spacing: 6px; }
        .heatmap-cell { 
            text-align: center; padding: 15px 5px; border-radius: 12px; 
            font-size: 0.9rem; cursor: pointer; border: 1px solid #eee; transition: 0.2s; 
            font-family: 'Pretendard';
        }
        .heatmap-cell:hover { transform: scale(1.05); border-color: #ffb7b2 !important; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; backdrop-filter: blur(3px); }
        .modal-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; width: 500px; max-height: 85vh; border-radius: 25px; 
            display: flex; flex-direction: column; padding: 30px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 2px solid #fff0f0;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; align-items: center; }
        .modal-title { font-size: 1.3rem; font-weight: bold; color: #333; }
        .student-item { display: flex; justify-content: space-between; padding: 15px 10px; border-bottom: 1px solid #f9f9f9; transition: 0.2s; }

        .ltv-card {
            background: #fdfdfd; border: 2px dashed #d1d5db; padding: 25px; border-radius: 20px; text-align: center;
        }
        .ltv-stat { font-size: 2rem; font-weight: bold; color: #5874ff; font-family: 'Pretendard'; }

        @media (max-width: 768px) {
            .navbar { padding: 0 15px; height: 60px; }
            .analysis-grid { grid-template-columns: 1fr; }
            .control-bar { flex-direction: column; width: 90%; padding: 20px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo">
            <i class="fa-solid fa-cloud"></i> <span> ì™œ ì¼ì€ í•œë²ˆì— ëª°ë ¤ì˜¤ëŠ” ê±¸ê¹Œìš”? ğŸŒ¸ </span>
        </a>
        <div class="nav-links">
            <a href="index.html" class="nav-item active"><i class="fa-solid fa-house"></i><span>í™ˆ</span></a>
            <a href="marker.html" class="nav-item"><i class="fa-solid fa-highlighter"></i><span>ì•½ì–´í‘œì‹œ</span></a>
            <a href="splitter.html" class="nav-item"><i class="fa-solid fa-align-left"></i><span>ë¶„í• </span></a>
            <a href="money.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>ë§¤ì¶œë¶„ì„</span></a>
        </div>
    </nav>

<div class="container">
    <div class="header-box">
        <h1>ğŸŒ¸ ì•„ì¹´ë°ë¯¸ ì„±ê³¼ ë¶„ì„ í”„ë¡œ</h1>
        <p style="color:#888; margin-top:5px;">ë§¤ì¶œ / PT / ë¬´ë£Œ ì²´í—˜ / <span style="color:#ff6f91; font-weight:bold;">í‚¤ë³´ë“œ êµ¬ë§¤ì</span> í†µí•© ë¶„ì„</p>
    </div>

    <div class="goal-wrapper">
        <div class="goal-input-area">
            <span style="font-weight:bold; color:#555;">ğŸ¯ ì´ë²ˆ ë‹¬ ëª©í‘œ ë§¤ì¶œ:</span>
            <input type="text" id="targetInput" placeholder="ê¸ˆì•¡ ì…ë ¥" onchange="calculateGoal()" onkeyup="inputNumberFormat(this)"> ì›
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="goalProgressBar">0%</div>
            <div class="goal-confetti" id="goalConfetti">ğŸ‰</div>
        </div>
    </div>

    <div class="control-bar">
        <button class="btn-style upload-btn" onclick="document.getElementById('fileInput').click()">
            <i class="fa-regular fa-folder-open"></i> ì—‘ì…€ íŒŒì¼ ì¶”ê°€ (ë‹¤ì¤‘ ì„ íƒ)
        </button>
        <button class="btn-style reset-btn" onclick="resetData()">
            <i class="fa-solid fa-rotate-right"></i> ì´ˆê¸°í™”
        </button>
        <select id="monthFilter" onchange="updateDashboard()">
            <option value="all">ğŸ“… ì „ì²´ ê¸°ê°„ ë³´ê¸°</option>
        </select>
        <button class="btn-style compare-btn" onclick="openCompareModal()">
            <i class="fa-solid fa-scale-balanced"></i> ì„±ê³¼ ë¹„êµ
        </button>
        <button class="btn-style report-btn" onclick="generateReport()">
            <i class="fa-solid fa-file-pen"></i> ë³´ê³ ì„œ ìƒì„±
        </button>
    </div>
    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;" multiple onchange="handleFiles(this)">

    <div id="dashboard" style="display: none;">
        <div id="insightSection" style="display: none;">
            <div class="section-title">âœ¨ ì›”ê°„ ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ (MoM)</div>
            <div class="insight-wrapper">
                <div class="insight-card">
                    <div class="insight-label">í‰ê·  ê°ë‹¨ê°€(ARPU)</div>
                    <div class="insight-value" id="insightArpu">0ì›</div>
                    <div class="insight-desc">í•™ìƒ 1ì¸ë‹¹ ê²°ì œì•¡</div>
                </div>
                <div class="insight-card">
                    <div class="insight-label">ì¬ë“±ë¡ë¥ </div>
                    <div class="insight-value" id="insightRetention">0%</div>
                    <div class="insight-desc">ê¸°ì¡´ í•™ìƒ ìœ ì§€ í˜„í™©</div>
                </div>
                <div class="insight-card" style="cursor:pointer;" onclick="showInsightList('ì‹ ê·œ ìœ ì… í•™ìƒ', 'new')">
                    <div class="insight-label">ì‹ ê·œ ìœ ì…</div>
                    <div class="insight-value" id="insightNew">0ëª…</div>
                </div>
                <div class="insight-card danger" style="cursor:pointer;" onclick="showInsightList('ì¬ë“±ë¡ í•„ìš” ëŒ€ìƒ(ì´íƒˆ ìœ„í—˜)', 'churn')">
                    <div class="insight-label" style="color:#ff6b6b">ì´íƒˆ ìœ„í—˜(ë¯¸ë“±ë¡)</div>
                    <div class="insight-value" id="insightChurn" style="color:#ff6b6b">0ëª…</div>
                </div>
            </div>
        </div>

        <div id="trendSection">
            <div class="section-title">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div>
            <div class="trend-card">
                <div style="height:300px;"><canvas id="chartTrend"></canvas></div>
            </div>
        </div>

        <div class="section-title"><span id="kpiTitle">ğŸ’° ì „ì²´ ë§¤ì¶œ í˜„í™©</span></div>
        <div class="kpi-wrapper">
            <div class="kpi-card total" onclick="showList('ìœ íš¨ ë§¤ì¶œ ì „ì²´', 'valid_sales')">
                <div class="kpi-label">ì´ ìœ íš¨ ë§¤ì¶œì•¡</div>
                <div class="kpi-amount" id="kpiTotalAmt">0ì›</div>
                <div class="kpi-count" id="kpiTotalCnt">0ê±´</div>
            </div>
            <div class="kpi-card cancel" onclick="showList('ì „ì²´ í™˜ë¶ˆ (0ì›)', 'full_cancel')">
                <div class="kpi-label">ì „ì²´ í™˜ë¶ˆ (ë§¤ì¶œ ì·¨ì†Œ)</div>
                <div class="kpi-amount" id="kpiCancelCnt">0ê±´</div>
            </div>
        </div>

        <div class="section-title">ğŸ”¥ ìˆ˜ì—… í˜¼ì¡ë„ íˆíŠ¸ë§µ</div>
        <div class="heatmap-container">
            <div id="heatmapArea"></div>
        </div>

        <div class="section-title">ğŸ“¦ ìƒí’ˆë³„ ìƒì„¸ ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="card">
                <h3>ìœ í˜•ë³„ ë§¤ì¶œ</h3>
                <div style="height:250px;"><canvas id="chartType"></canvas></div>
                <table id="tableType"><thead><tr><th>êµ¬ë¶„</th><th>ë§¤ì¶œ</th><th>ê±´ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3>ğŸ“ ë°˜(Class)ë³„ ì„¸ë¶„í™”</h3>
                <div style="height:250px;"><canvas id="chartClass"></canvas></div>
                <table id="tableClass"><thead><tr><th>ë°˜ì´ë¦„</th><th>ë§¤ì¶œ</th><th>ê±´ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="section-title">ğŸ† VIP ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="card">
                <h3>ğŸ’ ê²°ì œ ê¸ˆì•¡ TOP 10</h3>
                <table id="tableVip"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì´ ê²°ì œì•¡</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3>ğŸ’ ìˆ˜ê°•ìƒ ìƒì• ì£¼ê¸°(LTV)</h3>
                <div class="ltv-card">
                    <h4>í‰ê·  ìˆ˜ê°• ê¸°ê°„</h4>
                    <div class="ltv-stat" id="ltvAvgDuration">0ê°œì›”</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="studentModal" onclick="if(event.target.id==='studentModal') this.style.display='none'">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">í•™ìƒ ëª…ë‹¨</div>
            <span style="font-size:24px; cursor:pointer;" onclick="document.getElementById('studentModal').style.display='none'">&times;</span>
        </div>
        <div id="modalList" style="overflow-y:auto; flex:1;"></div>
    </div>
</div>

<script>
    let db = [], filteredDb = [], monthList = new Set();
    let freeUserDb = [], keyboardDb = []; 
    let churnList = [], newList = [];
    let currentKpi = { amt:0, cnt:0 };

    function resetData() {
        if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db = []; monthList.clear();
            document.getElementById('dashboard').style.display = 'none';
            alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    }

    function handleFiles(input) {
        const files = input.files;
        if (!files.length) return;
        let loadedCount = 0;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });
                processData(rows);
                loadedCount++;
                if(loadedCount === files.length) finalizeDataProcessing();
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function processData(rows) {
        if(!rows.length) return;
        let headerRowIdx = -1;
        for(let i=0; i<Math.min(rows.length, 10); i++) {
            const rowStr = rows[i].join('|');
            if(rowStr.includes('ì‹ ì²­ì •ë³´') || rowStr.includes('ì£¼ë¬¸ë²ˆí˜¸')) { headerRowIdx = i; break; }
        }
        if(headerRowIdx === -1) return;

        const headers = rows[headerRowIdx].map(h => String(h).trim());
        const headerStr = headers.join('|');

        // [êµ¬ë¶„ ë¡œì§ í•µì‹¬] 'ì „í™”ë²ˆí˜¸'ê°€ í—¤ë”ì— ì§ì ‘ ìˆìœ¼ë©´ ë‹¨ì¼í–‰(ìƒˆ íŒŒì¼), ì—†ìœ¼ë©´ ë©€í‹°í–‰(ê¸°ì¡´ íŒŒì¼)
        if (headerStr.includes('ì „í™”ë²ˆí˜¸')) {
            parseOrderListSales(rows, headerRowIdx);
        } else {
            parseGeneralSales(rows);
        }
    }

    // 1. ë‹¨ì¼í–‰ íŒŒì„œ (ìƒˆ í˜•ì‹: 2026...order_lists.xlsx)
    function parseOrderListSales(rows, headerIdx) {
        const headers = rows[headerIdx].map(h => String(h).trim());
        const colIdx = {
            date: headers.findIndex(h => h.includes('ì‹ ì²­ì •ë³´')),
            product: headers.findIndex(h => h.includes('ì„ íƒì •ë³´')),
            name: headers.findIndex(h => h.includes('ì‹ ì²­ì')),
            phone: headers.findIndex(h => h.includes('ì „í™”ë²ˆí˜¸')),
            price: headers.findIndex(h => h.includes('ê²°ì œê¸ˆì•¡')),
            status: headers.findIndex(h => h.includes('ê²°ì œìƒíƒœ'))
        };

        for (let i = headerIdx + 1; i < rows.length; i++) {
            let row = rows[i];
            if (!row[colIdx.date]) continue;
            let status = String(row[colIdx.status] || '').trim();
            if (status.includes('ì™„ë£Œ') || status.includes('ì·¨ì†Œ')) {
                let price = parseInt(String(row[colIdx.price]).replace(/[^\d]/g, '')) || 0;
                let dateObj = parseDate(row[colIdx.date]);
                let monthKey = getMonthKey(dateObj);
                if (!monthKey) continue;

                let productFull = String(row[colIdx.product] || '').replace(/\n/g, " ");
                let item = {
                    date: getDateStr(dateObj), dateObj: dateObj, month: monthKey,
                    name: String(row[colIdx.name]).trim(), phone: cleanPhone(row[colIdx.phone]),
                    product: productFull, price: price, status: status, option: productFull,
                    type: '', classInfo: '', dayInfo: '', timeInfo: '', isPartial: false, isFullCancel: false
                };
                processItemType(item);
                db.push(item);
                monthList.add(monthKey);
            }
        }
    }

    // 2. ë©€í‹°í–‰ íŒŒì„œ (ê¸°ì¡´ í˜•ì‹: 1211221.xlsx)
    function parseGeneralSales(rows) {
        let statusIdx = -1;
        for(let r=0; r<rows.length; r++) {
            for(let c=0; c<rows[r].length; c++) {
                if(String(rows[r][c]).includes('ê²°ì œìƒíƒœ')) { statusIdx = c; break; }
            }
            if(statusIdx !== -1) break;
        }
        if(statusIdx === -1) return;

        let i = 0;
        while(i < rows.length) {
            let row = rows[i];
            let status = String(row[statusIdx]).trim();
            if(status.includes('ì™„ë£Œ') || status.includes('ì·¨ì†Œ')) {
                let dateObj = parseDate(row[0]);
                let monthKey = getMonthKey(dateObj);
                if(!monthKey) { i++; continue; }

                let item = {
                    date: getDateStr(dateObj), dateObj: dateObj, month: monthKey, name: row[3],
                    phone: '', product: '', price: parseInt(String(row[statusIdx-1]).replace(/[^\d]/g, '')) || 0,
                    status: status, option: '', type: '', classInfo: '', dayInfo: '', timeInfo: '',
                    isPartial: false, isFullCancel: false
                };

                if(i+1 < rows.length) {
                    item.product = String(rows[i+1][1]);
                    item.phone = cleanPhone(rows[i+1][3]);
                    let inc = 2;
                    if(i+2 < rows.length && String(rows[i+2][1]).includes('ì˜µì…˜')) {
                        item.option = String(rows[i+2][1]);
                        inc = 3;
                    }
                    processItemType(item);
                    db.push(item);
                    monthList.add(monthKey);
                    i += inc;
                } else i++;
            } else i++;
        }
    }

    function processItemType(item) {
        if (item.status.includes('ì™„ë£Œ')) { /* OK */ }
        else if (item.status.includes('ì·¨ì†Œ') && item.price >= 10000) { item.isPartial = true; }
        else { item.isFullCancel = true; }

        if (item.product.includes('ì˜¬íŒ¨ìŠ¤')) item.type = 'ì˜¬íŒ¨ìŠ¤';
        else if (item.product.includes('ì‹œí—˜ëŒ€ë¹„') && item.product.includes('ìë£Œ')) item.type = 'ì‹œí—˜ëŒ€ë¹„ ìë£Œ';
        else if (item.product.includes('ì‹œí—˜ëŒ€ë¹„')) item.type = 'ì‹œí—˜ëŒ€ë¹„ CLASS';
        else item.type = 'í™”ìƒìˆ˜ì—…';

        if (item.product.includes('ì…ë¬¸')) item.classInfo = 'ì…ë¬¸/ì¤‘ê¸‰';
        else if (item.product.includes('ê³ ê¸‰')) item.classInfo = 'ê³ ê¸‰';
        else if (item.product.includes('ì‹¬ì•¼')) item.classInfo = 'ì‹¬ì•¼';

        let dM = item.option.match(/\[ìš”ì¼\]\s*([^,\]\s]+)/);
        if(dM) item.dayInfo = dM[1].trim();
        let tM = item.option.match(/\[ì‹œê°„\]\s*([^,\]\s]+)/);
        if(tM) {
            let tStr = tM[1].trim().replace(/[:ì‹œë¶„]/g, '').substring(0,2);
            item.timeInfo = parseInt(tStr);
        }
    }

    function finalizeDataProcessing() {
        populateFilter();
        updateDashboard();
        alert('ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ' + db.length + 'ê±´');
    }

    function updateDashboard() {
        const mon = document.getElementById('monthFilter').value;
        document.getElementById('dashboard').style.display = 'block';
        filteredDb = (mon === 'all') ? db : db.filter(i => i.month === mon);
        analyze(filteredDb, mon);
    }

    function analyze(data, mon) {
        let kpi = { amt:0, cnt:0, cancel:0 };
        let cats = { type:{}, class:{} }, stu = {}, hm = {};
        const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
        days.forEach(d => hm[d] = {});

        data.forEach(i => {
            if(i.isFullCancel) { kpi.cancel++; return; }
            kpi.amt += i.price; kpi.cnt++;
            
            if(!cats.type[i.type]) cats.type[i.type] = {amt:0, cnt:0, list:[]};
            cats.type[i.type].amt += i.price; cats.type[i.type].cnt++; cats.type[i.type].list.push(i);

            if(i.classInfo) {
                if(!cats.class[i.classInfo]) cats.class[i.classInfo] = {amt:0, cnt:0, list:[]};
                cats.class[i.classInfo].amt += i.price; cats.class[i.classInfo].cnt++; cats.class[i.classInfo].list.push(i);
            }

            if(i.dayInfo && i.timeInfo) {
                i.dayInfo.split('').forEach(d => { if(hm[d]) hm[d][i.timeInfo] = (hm[d][i.timeInfo]||0)+1; });
            }

            let key = i.phone || i.name;
            if(!stu[key]) stu[key] = {name:i.name, amt:0, list:[]};
            stu[key].amt += i.price; stu[key].list.push(i);
        });

        document.getElementById('kpiTotalAmt').innerText = kpi.amt.toLocaleString() + 'ì›';
        document.getElementById('kpiTotalCnt').innerText = kpi.cnt + 'ê±´';
        document.getElementById('kpiCancelCnt').innerText = kpi.cancel + 'ê±´';

        renderChart('chartType', cats.type, 'ë§¤ì¶œ');
        renderChart('chartClass', cats.class, 'ë§¤ì¶œ');
        renderTable('tableType', cats.type);
        renderTable('tableClass', cats.class);
        renderVip(stu);
        renderHeatmap(hm);
    }

    function renderHeatmap(hm) {
        const times = [9,10,11,14,15,16,17,19,20,21];
        const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
        let html = '<table class="heatmap-table"><thead><tr><th></th>';
        times.forEach(t=>html+=`<th>${t}</th>`);
        html+='</tr></thead><tbody>';
        days.forEach(d=>{
            html+=`<tr><th>${d}</th>`;
            times.forEach(t=>{
                let cnt = hm[d][t] || 0;
                let bg = cnt > 0 ? `rgba(255, 183, 178, ${Math.min(1, cnt/10 + 0.2)})` : '#fdfdfd';
                html+=`<td class="heatmap-cell" style="background:${bg}">${cnt||'-'}</td>`;
            });
            html+='</tr>';
        });
        document.getElementById('heatmapArea').innerHTML = html+'</tbody></table>';
    }

    function renderChart(id, obj, label) {
        let keys = Object.keys(obj);
        let vals = keys.map(k => obj[k].amt);
        let ctx = document.getElementById(id).getContext('2d');
        if(Chart.getChart(id)) Chart.getChart(id).destroy();
        new Chart(ctx, {
            type: 'doughnut',
            data: { labels: keys, datasets: [{ data: vals, backgroundColor: ['#ffb7b2', '#a2c2ff', '#95e1d3', '#ffd700'] }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderTable(id, obj) {
        let tb = document.querySelector(`#${id} tbody`);
        tb.innerHTML = '';
        Object.keys(obj).forEach(k => {
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${k}</td><td>${obj[k].amt.toLocaleString()}ì›</td><td>${obj[k].cnt}ê±´</td><td class="clickable-row" onclick='showList("${k}", "list", ${JSON.stringify(obj[k].list)})'>í™•ì¸</td>`;
            tb.appendChild(tr);
        });
    }

    function renderVip(stu) {
        let list = Object.values(stu).sort((a,b)=>b.amt-a.amt).slice(0,10);
        let tb = document.querySelector('#tableVip tbody');
        tb.innerHTML = '';
        list.forEach((s,i)=>{
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td>${s.amt.toLocaleString()}ì›</td><td class="clickable-row" onclick='showList("${s.name}", "list", ${JSON.stringify(s.list)})'>í™•ì¸</td>`;
            tb.appendChild(tr);
        });
    }

    function showList(title, type, list) {
        document.getElementById('modalTitle').innerText = title;
        let html = '';
        list.forEach(i => {
            html += `<div class="student-item">
                <div><b>${i.name}</b> <span style="font-size:12px; color:#888;">${i.product}</span></div>
                <div>${i.price.toLocaleString()}ì›</div>
            </div>`;
        });
        document.getElementById('modalList').innerHTML = html;
        document.getElementById('studentModal').style.display = 'flex';
    }

    function parseDate(raw) {
        if(!raw) return null;
        let str = String(raw).trim();
        if(!isNaN(str) && str.length > 4 && str.length < 6) return new Date((Number(str)-25569)*86400*1000);
        return new Date(str.replace(/[./]/g, '-').split(' ')[0]);
    }
    function getMonthKey(d) { return d && !isNaN(d) ? `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` : ""; }
    function getDateStr(d) { return d ? d.toISOString().split('T')[0] : ""; }
    function cleanPhone(s) { return String(s||"").replace(/[^\d]/g, ''); }
    function populateFilter() {
        const sel = document.getElementById('monthFilter');
        sel.innerHTML = '<option value="all">ğŸ“… ì „ì²´ ê¸°ê°„ ë³´ê¸°</option>';
        Array.from(monthList).sort().reverse().forEach(m => sel.innerHTML += `<option value="${m}">${m}ì›” ë§¤ì¶œ</option>`);
    }
    function inputNumberFormat(obj) { obj.value = obj.value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function calculateGoal() {
        let target = parseInt(document.getElementById('targetInput').value.replace(/,/g, '')) || 0;
        let current = currentKpi.amt;
        let pct = target ? Math.min(100, Math.round(current/target*100)) : 0;
        document.getElementById('goalProgressBar').style.width = pct + '%';
        document.getElementById('goalProgressBar').innerText = pct + '%';
    }
</script>
</body>
</html>
