<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì•„ì¹´ë°ë¯¸ ì„±ê³¼ ë¶„ì„ í”„ë¡œ(Pro) - í†µí•© ì™„ì„±íŒ (+ë‹¨ì¼í–‰ ì—‘ì…€ ì§€ì›)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --bg-cream: #fdfbf7;
            --card-white: #ffffff;
            --pastel-pink: #ffb7b2;
            --pastel-blue: #a2c2ff;
            --pastel-mint: #95e1d3;
            --text-main: #4a4a4a;
            --text-sub: #666666; 
            --border-line: #f0ebeb; 
        }

        body {
            font-family: 'Gowun Dodum', 'Pretendard', sans-serif;
            margin: 0;
            background-color: var(--bg-cream);
            color: var(--text-main);
            padding-top: 90px;
            padding-bottom: 50px;
        }

        /* --- [ë©”ë‰´ë°”] --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; box-sizing: border-box; z-index: 1000;
            border-bottom: 2px solid #fff0f0;
            box-shadow: 0 4px 15px rgba(230, 210, 200, 0.1); 
        }
        .logo {
            font-size: 1.3rem; color: #4a4a4a; text-decoration: none;
            display: flex; align-items: center; gap: 8px; font-weight: bold;
        }
        .logo i { color: #ff9aa2; font-size: 1.2em; }
        .nav-links { display: flex; gap: 8px; }
        .nav-item {
            text-decoration: none; color: #888; font-weight: 600; padding: 8px 15px;
            border-radius: 20px; transition: all 0.3s;
            display: flex; align-items: center; gap: 6px; font-size: 0.95rem;
        }
        .nav-item:hover, .nav-item.active {
            background-color: #fff0f5; color: #ff6f91; transform: translateY(-2px);
        }

        /* --- [ë ˆì´ì•„ì›ƒ] --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header-box { text-align: center; margin-bottom: 30px; }
        .header-box h1 { font-size: 2rem; color: #4a4a4a; margin-bottom: 10px; letter-spacing: -1px; }

        /* ëª©í‘œ ë‹¬ì„± ê²Œì´ì§€ */
        .goal-wrapper {
            max-width: 800px; margin: 0 auto 30px auto;
            background: #fff; padding: 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0ebeb; text-align: center;
        }
        .goal-input-area { margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .goal-input-area input {
            padding: 8px 15px; border: 1px solid #ddd; border-radius: 10px; 
            font-family: 'Pretendard'; font-size: 1rem; width: 120px; text-align: right;
        }
        .progress-container {
            height: 24px; background-color: #f0f0f0; border-radius: 12px; overflow: hidden; position: relative;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #a2c2ff, #95e1d3);
            width: 0%; transition: width 1s ease-in-out;
            display: flex; align-items: center; justify-content: flex-end; padding-right: 10px;
            color: white; font-weight: bold; font-size: 0.85rem;
        }
        .goal-confetti { position: absolute; right: 10px; top: -20px; font-size: 20px; display: none; }

        /* ì»¨íŠ¸ë¡¤ ë°” */
        .control-bar { 
            display: flex; justify-content: center; gap: 10px; margin-top: 15px; 
            background: white; padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(200, 200, 200, 0.15);
            border: 2px solid #fff0f0;
            max-width: 850px; margin-left: auto; margin-right: auto;
            align-items: center; flex-wrap: wrap;
        }

        .btn-style {
            padding: 10px 20px; border-radius: 30px; 
            font-size: 0.95rem; font-weight: bold; cursor: pointer; border: none; 
            transition: 0.2s; font-family: 'Gowun Dodum', sans-serif;
            display: flex; align-items: center; gap: 6px;
        }
        .upload-btn { background: #f0f4ff; color: #5874ff; }
        .upload-btn:hover { background: #dce7ff; transform: translateY(-2px); }
        .compare-btn { background: #fff0f5; color: #ff6f91; }
        .compare-btn:hover { background: #ffe0ea; transform: translateY(-2px); }
        .report-btn { background: #e0f7fa; color: #0097a7; }
        .report-btn:hover { background: #b2ebf2; transform: translateY(-2px); }
        .reset-btn { background: #f5f5f5; color: #666; }
        .reset-btn:hover { background: #e0e0e0; transform: translateY(-2px); }

        select { 
            padding: 10px 20px; border-radius: 30px; 
            border: 2px solid #f0ebeb; font-size: 1rem; cursor: pointer; outline: none; 
            font-family: 'Gowun Dodum', sans-serif; color: #555; background: #fff;
        }
        select:hover { border-color: #ffb7b2; }

        .section-title { 
            font-size: 1.4rem; font-weight: bold; margin: 50px 0 20px 0; 
            display: flex; align-items: center; gap: 10px; color: #333;
        }
        .section-title::before {
            content: ''; display: block; width: 6px; height: 24px; 
            background: #ffb7b2; border-radius: 3px;
        }

        /* --- [ì¹´ë“œ ë° ê·¸ë¦¬ë“œ] --- */
        .card, .trend-card, .heatmap-container, .kpi-card, .insight-card, .conversion-card {
            background: #ffffff; border-radius: 25px; padding: 30px;
            border: 2px solid #f0ebeb; box-shadow: 0 8px 20px rgba(200, 200, 200, 0.1);
            transition: all 0.3s ease; position: relative;
        }
        .card:hover, .trend-card:hover, .kpi-card:hover, .insight-card:hover, .conversion-card:hover {
            border-color: #ffe0e0; box-shadow: 0 15px 30px rgba(255, 183, 178, 0.2);
            transform: translateY(-5px);
        }

        /* KPI & Insight */
        .kpi-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 20px; }
        .kpi-card { text-align: center; cursor: pointer; }
        .kpi-label { font-size: 1.1rem; color: #666; margin-bottom: 10px; }
        .kpi-amount { font-size: 2rem; font-weight: bold; margin: 5px 0; font-family: 'Pretendard'; }
        .total .kpi-amount { color: #8cb6ff; }
        .cancel .kpi-amount { color: #ff9aa2; }

        .insight-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .insight-card { padding: 25px 20px; text-align: center; }
        .insight-label { font-size: 0.95rem; color: #999; margin-bottom: 8px; font-family: 'Pretendard'; }
        .insight-value { font-size: 1.7rem; font-weight: bold; color: #4a4a4a; margin-bottom: 8px; font-family: 'Pretendard'; }
        .insight-desc { font-size: 0.85rem; color: #666; font-family: 'Gowun Dodum'; }
        .insight-card.danger { border: 2px solid #ffcfce; background: #fffafa; }
        .badge-re { background: #eef2ff; color: #5874ff; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; display: inline-block; margin-top: 5px; }

        /* ê·¸ë¦¬ë“œ & í…Œì´ë¸” */
        .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-top: 15px; }
        th { background: #fff8f8; color: #666; padding: 12px; text-align: left; border-bottom: 2px solid #ffebeb; font-weight: bold; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; color: #555; }
        tr:hover td { background: #fffcfc; }
        .clickable-row { cursor: pointer; color: #8cb6ff; font-weight: bold; text-decoration: none; }
        .clickable-row:hover { text-decoration: underline; }

        /* íˆíŠ¸ë§µ */
        .heatmap-container { overflow-x: auto; padding: 20px; }
        .heatmap-table { width: 100%; border-collapse: separate; border-spacing: 6px; }
        .heatmap-cell { 
            text-align: center; padding: 15px 5px; border-radius: 12px; 
            font-size: 0.9rem; cursor: pointer; border: 1px solid #eee; transition: 0.2s; 
            font-family: 'Pretendard';
        }
        .heatmap-cell:hover { transform: scale(1.05); border-color: #ffb7b2 !important; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* ì „í™˜ìœ¨ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .conversion-stats { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .conv-stat-box { text-align: center; }
        .conv-label { font-size: 0.9rem; color: #888; margin-bottom: 5px; }
        .conv-val { font-size: 1.4rem; font-weight: bold; color: #555; font-family: 'Pretendard'; }
        .conv-rate { color: #8cb6ff; font-size: 2rem; }

        /* ë­í‚¹ ë±ƒì§€ */
        .rank-badge { 
            background: #f0f0f0; color: #666; width: 26px; height: 26px; 
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; 
            font-size: 12px; font-weight: bold; margin-right: 5px;
        }
        .rank-1 { background: #ffd700; color: #fff; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); } 
        .rank-2 { background: #c0c0c0; color: #fff; } 
        .rank-3 { background: #cd7f32; color: #fff; }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; backdrop-filter: blur(3px); }
        .modal-box { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; width: 500px; max-height: 85vh; border-radius: 25px; 
            display: flex; flex-direction: column; padding: 30px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 2px solid #fff0f0;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; align-items: center; }
        .modal-title { font-size: 1.3rem; font-weight: bold; color: #333; }
        
        .student-item { display: flex; justify-content: space-between; padding: 15px 10px; border-bottom: 1px solid #f9f9f9; transition: 0.2s; }
        .student-item:hover { background: #fffcfc; border-radius: 10px; }
        .badge-partial { font-size: 11px; background: #fff3cd; color: #856404; padding: 3px 8px; border-radius: 10px; margin-left: 5px; }
        
        /* ë¹„êµ ëª¨ë‹¬ ì „ìš© */
        .compare-grid-modal { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .compare-col { background: #fafafa; padding: 15px; border-radius: 15px; text-align: center; }
        .compare-val { font-size: 1.5rem; font-weight: bold; font-family: 'Pretendard'; margin: 10px 0; }
        .delta-pos { color: #ff6f91; font-weight: bold; }
        .delta-neg { color: #8cb6ff; font-weight: bold; }

        /* ë³´ê³ ì„œ í…ìŠ¤íŠ¸ ì˜ì—­ */
        .report-textarea {
            width: 100%; height: 300px; padding: 15px; border: 2px solid #eee; border-radius: 15px;
            font-family: 'Pretendard'; font-size: 1rem; line-height: 1.6; resize: none; background: #fafafa; outline: none;
        }

        /* LTV ì„¹ì…˜ */
        .ltv-card {
            background: #fdfdfd; border: 2px dashed #d1d5db; padding: 25px; border-radius: 20px; text-align: center;
        }
        .ltv-stat { font-size: 2rem; font-weight: bold; color: #5874ff; font-family: 'Pretendard'; }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .navbar { padding: 0 15px; height: 60px; }
            .logo span, .nav-item span { display: none; } 
            .logo i, .nav-item i { font-size: 1.2rem; }
            .analysis-grid { grid-template-columns: 1fr; }
            .control-bar { flex-direction: column; width: 90%; padding: 20px; }
            .btn-style, select { width: 100%; justify-content: center; }
            .modal-box { width: 90%; }
            .compare-grid-modal { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html" class="logo">
            <i class="fa-solid fa-cloud"></i> <span> ì™œ ì¼ì€ í•œë²ˆì— ëª°ë ¤ì˜¤ëŠ” ê±¸ê¹Œìš”? ğŸŒ¸ </span>
        </a>
        <div class="nav-links">
            <a href="index.html" class="nav-item active"><i class="fa-solid fa-house"></i><span>í™ˆ</span></a>
            <a href="marker.html" class="nav-item"><i class="fa-solid fa-highlighter"></i><span>ì•½ì–´í‘œì‹œ</span></a>
            <a href="splitter.html" class="nav-item"><i class="fa-solid fa-align-left"></i><span>ë¶„í• </span></a>
            <a href="money.html" class="nav-item"><i class="fa-solid fa-chart-line"></i><span>ë§¤ì¶œë¶„ì„</span></a>
        </div>
    </nav>

<div class="container">
    <div class="header-box">
        <h1>ğŸŒ¸ ì•„ì¹´ë°ë¯¸ ì„±ê³¼ ë¶„ì„ í”„ë¡œ</h1>
        <p style="color:#888; margin-top:5px;">ë§¤ì¶œ / PT / ë¬´ë£Œ ì²´í—˜ / <span style="color:#ff6f91; font-weight:bold;">í‚¤ë³´ë“œ êµ¬ë§¤ì</span> í†µí•© ë¶„ì„</p>
    </div>

    <div class="goal-wrapper">
        <div class="goal-input-area">
            <span style="font-weight:bold; color:#555;">ğŸ¯ ì´ë²ˆ ë‹¬ ëª©í‘œ ë§¤ì¶œ:</span>
            <input type="text" id="targetInput" placeholder="ê¸ˆì•¡ ì…ë ¥" onchange="calculateGoal()" onkeyup="inputNumberFormat(this)"> ì›
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="goalProgressBar">0%</div>
            <div class="goal-confetti" id="goalConfetti">ğŸ‰</div>
        </div>
        <div style="font-size:0.85rem; color:#999; margin-top:5px;">ëª©í‘œë¥¼ ì…ë ¥í•˜ê³  ì—”í„°ë¥¼ ì¹˜ì„¸ìš”!</div>
    </div>

    <div class="control-bar">
        <button class="btn-style upload-btn" onclick="document.getElementById('fileInput').click()">
            <i class="fa-regular fa-folder-open"></i> ì—‘ì…€ íŒŒì¼ ì¶”ê°€ (ë‹¤ì¤‘ ì„ íƒ)
        </button>
        <button class="btn-style reset-btn" onclick="resetData()">
            <i class="fa-solid fa-rotate-right"></i> ì´ˆê¸°í™”
        </button>
        <select id="monthFilter" onchange="updateDashboard()">
            <option value="all">ğŸ“… ì „ì²´ ê¸°ê°„ ë³´ê¸°</option>
        </select>
        <button class="btn-style compare-btn" onclick="openCompareModal()">
            <i class="fa-solid fa-scale-balanced"></i> ì„±ê³¼ ë¹„êµ
        </button>
        <button class="btn-style report-btn" onclick="generateReport()">
            <i class="fa-solid fa-file-pen"></i> ë³´ê³ ì„œ ìƒì„±
        </button>
    </div>
    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;" multiple onchange="handleFiles(this)">

    <div id="dashboard" style="display: none;">
        <div id="insightSection" style="display: none;">
            <div class="section-title">âœ¨ ì›”ê°„ ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ (MoM)</div>
            <div class="insight-wrapper">
                <div class="insight-card">
                    <div class="insight-label">í‰ê·  ê°ë‹¨ê°€(ARPU)</div>
                    <div class="insight-value" id="insightArpu">0ì›</div>
                    <div class="insight-desc">í•™ìƒ 1ì¸ë‹¹ ê²°ì œì•¡</div>
                </div>
                <div class="insight-card">
                    <div class="insight-label">ì¬ë“±ë¡ë¥ </div>
                    <div class="insight-value" id="insightRetention">0%</div>
                    <div class="insight-desc">ê¸°ì¡´ í•™ìƒ ìœ ì§€ í˜„í™©</div>
                </div>
                <div class="insight-card" style="cursor:pointer;" onclick="showInsightList('ì‹ ê·œ ìœ ì… í•™ìƒ', 'new')">
                    <div class="insight-label">ì‹ ê·œ ìœ ì…</div>
                    <div class="insight-value" id="insightNew">0ëª…</div>
                    <div class="insight-desc">ì´ë²ˆ ë‹¬ ì²« ë“±ë¡</div>
                </div>
                <div class="insight-card danger" style="cursor:pointer;" onclick="showInsightList('ì¬ë“±ë¡ í•„ìš” ëŒ€ìƒ(ì´íƒˆ ìœ„í—˜)', 'churn')">
                    <div class="insight-label" style="color:#ff6b6b">ì´íƒˆ ìœ„í—˜(ë¯¸ë“±ë¡)</div>
                    <div class="insight-value" id="insightChurn" style="color:#ff6b6b">0ëª…</div>
                    <div class="badge-re">ì¬ë“±ë¡ í•„ìš” ëŒ€ìƒ</div>
                </div>
            </div>
        </div>

        <div id="trendSection">
            <div class="section-title">ğŸ“ˆ ì›”ë³„ ë§¤ì¶œ ì¶”ì´</div>
            <div class="trend-card">
                <div style="height:300px;"><canvas id="chartTrend"></canvas></div>
            </div>
        </div>

        <div class="section-title"><span id="kpiTitle">ğŸ’° ì „ì²´ ë§¤ì¶œ í˜„í™©</span></div>
        <div class="kpi-wrapper">
            <div class="kpi-card total" onclick="showList('ìœ íš¨ ë§¤ì¶œ ì „ì²´', 'valid_sales')">
                <div class="icon-circle" style="background:#f0f4ff; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; color:#8cb6ff;"><i class="fa-solid fa-coins"></i></div>
                <div class="kpi-label">ì´ ìœ íš¨ ë§¤ì¶œì•¡</div>
                <div class="kpi-amount" id="kpiTotalAmt">0ì›</div>
                <div class="kpi-count" id="kpiTotalCnt" style="color:#666; margin-top:5px;">0ê±´</div>
                <div style="font-size:12px; color:#999; margin-top:5px;">(ê°•ì¢Œ + PTê¶Œ í•©ê³„)</div>
            </div>
            <div class="kpi-card cancel" onclick="showList('ì „ì²´ í™˜ë¶ˆ (0ì›)', 'full_cancel')">
                <div class="icon-circle" style="background:#fff0f0; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 10px; color:#ff9aa2;"><i class="fa-solid fa-ban"></i></div>
                <div class="kpi-label">ì „ì²´ í™˜ë¶ˆ (ë§¤ì¶œ ì·¨ì†Œ)</div>
                <div class="kpi-amount" id="kpiCancelCnt" style="font-size:1.8rem;">0ê±´</div>
                <div style="font-size:12px; color:#ff6f91; margin-top:5px;">* ìˆ˜ê°• ì‹œì‘ ì „ ì·¨ì†Œ ê±´ìˆ˜</div>
            </div>
        </div>

        <div id="keyboardSection" style="display:none;">
            <div class="section-title">âŒ¨ï¸ í‚¤ë³´ë“œ êµ¬ë§¤ì ì‹¬ì¸µ ë¶„ì„</div>
            <div class="analysis-grid">
                <div class="conversion-card" style="grid-column: span 2;">
                    <div class="conversion-stats">
                        <div class="conv-stat-box">
                            <div class="conv-label">ì´ í‚¤ë³´ë“œ êµ¬ë§¤ì</div>
                            <div class="conv-val" id="kbTotal">0ëª…</div>
                        </div>
                        <div class="conv-stat-box">
                            <div class="conv-label">ìˆ˜ê°•ìƒ ì „í™˜ ì„±ê³µ</div>
                            <div class="conv-val" id="kbSuccess" style="color:#ff6f91;">0ëª…</div>
                        </div>
                        <div class="conv-stat-box">
                            <div class="conv-label">ì „í™˜ìœ¨</div>
                            <div class="conv-val conv-rate" id="kbRate" style="color:#ff6f91;">0%</div>
                        </div>
                         <div class="conv-stat-box">
                            <div class="conv-label">í‰ê·  ìˆ˜ê°• ë“±ë¡ ì†Œìš”ì‹œê°„</div>
                            <div class="conv-val" id="kbAvgDays" style="color:#666; font-size:1.4rem;">0ì¼</div>
                            <div style="font-size:0.8rem; color:#aaa;">(êµ¬ë§¤ í›„ ì²« ê²°ì œê¹Œì§€)</div>
                        </div>
                    </div>
                    
                    <div style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-top:20px;">
                        <div style="flex:1; min-width:300px; text-align:center;">
                            <h4 style="color:#666;">â³ êµ¬ë§¤ í›„ ìˆ˜ê°• ì‹ ì²­ê¹Œì§€ ê±¸ë¦° ì‹œê°„</h4>
                             <div style="height:250px;"><canvas id="chartKbTime"></canvas></div>
                        </div>
                        <div style="flex:1; min-width:300px; text-align:center;">
                            <h4 style="color:#666;">ğŸ“ ì²« ìˆ˜ê°• ì‹ ì²­ ê³¼ëª© ì„ í˜¸ë„</h4>
                             <div style="height:250px;"><canvas id="chartKbClass"></canvas></div>
                        </div>
                    </div>
                    
                    <div style="margin-top:30px;">
                        <h4 style="color:#666;">ğŸ‚ ì—°ë ¹ëŒ€ë³„ ìˆ˜ê°• ì „í™˜ ë¶„í¬</h4>
                        <div style="height:250px;"><canvas id="chartKbAge"></canvas></div>
                        <p style="text-align:center; color:#999; font-size:0.8rem; margin-top:5px;">* ì—‘ì…€ì— ìƒë…„ ì •ë³´(ì˜ˆ: 1990, 90 ë“±)ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>

                    <div style="margin-top:30px;">
                        <h3 style="margin-top:0; color:#444;">ğŸ‰ í‚¤ë³´ë“œ êµ¬ë§¤ -> ìˆ˜ê°•ìƒ ì „í™˜ ëª…ë‹¨</h3>
                        <div style="overflow-y: auto; max-height: 300px; border:1px solid #eee; border-radius:10px; padding:10px;">
                            <table id="tableKbConversion">
                                <thead><tr><th>ì´ë¦„</th><th>êµ¬ë§¤ì¼</th><th>ì²« ìˆ˜ê°•ì¼</th><th>ì†Œìš”ê¸°ê°„</th><th>ì²« ê³¼ëª©</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title">ğŸ†“ ë¬´ë£Œ ì²´í—˜ ì „í™˜ìœ¨ ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="conversion-card" style="grid-column: span 2;">
                <h3 style="margin-top:0; color:#444;">ë¬´ë£Œ ì‚¬ìš©ì ìœ ë£Œ ê²°ì œ ì „í™˜ ë¶„ì„</h3>
                <div class="conversion-stats">
                    <div class="conv-stat-box">
                        <div class="conv-label">ì´ ë¬´ë£Œì²´í—˜</div>
                        <div class="conv-val" id="convTotal">0ëª…</div>
                    </div>
                    <div class="conv-stat-box">
                        <div class="conv-label">ìœ ë£Œ ì „í™˜ ì„±ê³µ</div>
                        <div class="conv-val" id="convSuccess" style="color:#10b981;">0ëª…</div>
                    </div>
                    <div class="conv-stat-box">
                        <div class="conv-label">ì „í™˜ìœ¨</div>
                        <div class="conv-val conv-rate" id="convRate">0%</div>
                    </div>
                </div>
                
                <div style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-top:20px;">
                    <div style="flex:1; min-width:300px; text-align:center;">
                        <h4 style="color:#666; margin-bottom:10px;">ğŸ“Š ì „í™˜ vs ë¯¸ì „í™˜</h4>
                        <div style="height:250px;"><canvas id="chartConversion"></canvas></div>
                    </div>
                    <div style="flex:1; min-width:300px; text-align:center;">
                        <h4 style="color:#666; margin-bottom:10px;">ğŸ° ì „í™˜ ìƒí’ˆ ìƒì„¸ ë¹„ìœ¨</h4>
                        <div style="height:250px;"><canvas id="chartConversionDetail"></canvas></div>
                    </div>
                </div>

                <div style="margin-top:30px;">
                    <h3 style="margin-top:0; color:#444;">ğŸ‰ ìœ ë£Œ ì „í™˜ ì„±ê³µ ëª…ë‹¨</h3>
                    <div style="overflow-y: auto; max-height: 300px; border:1px solid #eee; border-radius:10px; padding:10px;">
                        <table id="tableConversion">
                            <thead><tr><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ì „í™˜ëœ ìƒí’ˆ(ëŒ€í‘œ)</th><th>í™•ì¸</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title">ğŸ”¥ ìˆ˜ì—… í˜¼ì¡ë„ íˆíŠ¸ë§µ (í™”ìƒìˆ˜ì—…/CLASS)</div>
        <div class="heatmap-container">
            <div id="heatmapArea"></div>
            <p style="color:#999; font-size:0.85rem; margin-top:10px; text-align:right;">* PTê¶Œ ë° ìš”ì¼/ì‹œê°„ ì •ë³´ê°€ ì—†ëŠ” ê±´ì€ ì œì™¸ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="section-title">ğŸ“¦ ìƒí’ˆë³„ ìƒì„¸ ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="card">
                <h3 style="margin-top:0; color:#444;">ìœ í˜•ë³„ ë§¤ì¶œ (PT í¬í•¨)</h3>
                <div style="height:250px;"><canvas id="chartType"></canvas></div>
                <table id="tableType"><thead><tr><th>êµ¬ë¶„</th><th>ë§¤ì¶œ</th><th>ê±´ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3 style="margin-top:0; color:#444;">ğŸ“ ë°˜(Class)ë³„ ì„¸ë¶„í™” ë¶„í¬</h3>
                <div style="height:250px;"><canvas id="chartClass"></canvas></div>
                <table id="tableClass"><thead><tr><th>ë°˜ì´ë¦„</th><th>ë§¤ì¶œ</th><th>ê±´ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="section-title">ğŸ“† ì˜µì…˜(ìš”ì¼/ì‹œê°„) í†µê³„</div>
        <div class="analysis-grid">
            <div class="card">
                <h3 style="margin-top:0; color:#444;">ìš”ì¼ë³„ ìˆ˜ê°•ìƒ(í™”ìƒìˆ˜ì—…+ì‹œëŒ€ë°˜)</h3>
                <div style="height:250px;"><canvas id="chartDay"></canvas></div>
                <table id="tableDay"><thead><tr><th>ìš”ì¼</th><th>ì¸ì›ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3 style="margin-top:0; color:#444;">â° ì‹œê°„ëŒ€ë³„ ìˆ˜ê°•ìƒ (ì˜¤ë¦„ì°¨ìˆœ)</h3>
                <div style="height:250px;"><canvas id="chartTime"></canvas></div>
                <table id="tableTime"><thead><tr><th>ì‹œê°„</th><th>ì¸ì›ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="section-title">ğŸ† VIP & ì¬ë“±ë¡ ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="card">
                <h3 style="margin-top:0; color:#444;">ğŸ’ ê²°ì œ ê¸ˆì•¡ TOP 10</h3>
                <table id="tableVip"><thead><tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ì´ ê²°ì œì•¡</th><th>ê±´ìˆ˜</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="card">
                <h3 style="margin-top:0; color:#444;">ğŸ† VIP ì¬ê²°ì œ íšŸìˆ˜ TOP 10</h3>
                <table id="tableRevisit"><thead><tr><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ê²°ì œíšŸìˆ˜</th><th>ì´ì•¡</th><th>í™•ì¸</th></tr></thead><tbody></tbody></table>
            </div>
        </div>

        <div class="section-title">ğŸ’ ìˆ˜ê°•ìƒ ìƒì• ì£¼ê¸°(LTV) ë¶„ì„</div>
        <div class="analysis-grid">
            <div class="ltv-card">
                <h4>ì´ ìˆ˜ê°•ìƒ ìˆ˜ (Unique)</h4>
                <div class="ltv-stat" id="ltvTotalStudents">0ëª…</div>
                <p style="color:#888; font-size:0.9rem;">í•™ì›ì„ ê±°ì³ê°„ ëª¨ë“  í•™ìƒ</p>
            </div>
            <div class="ltv-card">
                <h4>í‰ê·  ìˆ˜ê°• ê°œì›” ìˆ˜</h4>
                <div class="ltv-stat" id="ltvAvgDuration">0ê°œì›”</div>
                <p style="color:#888; font-size:0.9rem;">í•œ í•™ìƒì´ ë¨¸ë¬´ëŠ” í‰ê·  ê¸°ê°„</p>
            </div>
            <div class="card">
                <h4 style="margin-top:0;">ìˆ˜ê°• ê¸°ê°„ ë¶„í¬ (ì¶©ì„±ë„)</h4>
                <div style="height:200px;"><canvas id="chartLtv"></canvas></div>
            </div>
        </div>

    </div>
</div>

<div class="modal-overlay" id="studentModal" onclick="if(event.target.id==='studentModal') this.style.display='none'">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">í•™ìƒ ëª…ë‹¨</div>
            <div style="display:flex; align-items:center;">
                <button class="btn-style upload-btn" onclick="copyList()"><i class="fa-regular fa-copy"></i> ë³µì‚¬</button>
                <span style="font-size:24px; cursor:pointer; margin-left:15px; color:#aaa;" onclick="document.getElementById('studentModal').style.display='none'">&times;</span>
            </div>
        </div>
        <div id="modalList" style="overflow-y:auto; flex:1;"></div>
    </div>
</div>

<div class="modal-overlay" id="compareModal" onclick="if(event.target.id==='compareModal') this.style.display='none'">
    <div class="modal-box" style="width:700px;">
        <div class="modal-header">
            <div class="modal-title">ğŸ†š ì›”ë³„ ì„±ê³¼ ë¹„êµ</div>
            <span style="font-size:24px; cursor:pointer; color:#aaa;" onclick="document.getElementById('compareModal').style.display='none'">&times;</span>
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
            <select id="compA"></select> 
            <span style="font-size:1.5rem; color:#ccc;">VS</span>
            <select id="compB"></select>
            <button class="btn-style compare-btn" onclick="doCompare()">ë¹„êµ ì‹¤í–‰</button>
        </div>
        
        <div id="compareResult" style="display:none; flex:1; overflow-y:auto;">
            <div class="compare-grid-modal">
                <div class="compare-col">
                    <div id="compLabelA" style="color:#888; font-weight:bold;">Aì›”</div>
                    <div class="compare-val" id="compValA">0ì›</div>
                </div>
                <div class="compare-col">
                    <div id="compLabelB" style="color:#888; font-weight:bold;">Bì›”</div>
                    <div class="compare-val" id="compValB">0ì›</div>
                </div>
            </div>
            <div style="text-align:center; margin:15px 0; font-size:1.1rem;">
                ë§¤ì¶œ ì°¨ì´: <span id="compDiff">0ì›</span>
            </div>
            <div style="height:250px;"><canvas id="chartCompare"></canvas></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="reportModal" onclick="if(event.target.id==='reportModal') this.style.display='none'">
    <div class="modal-box" style="width:600px;">
        <div class="modal-header">
            <div class="modal-title">ğŸ“ ìë™ ìƒì„±ëœ ì„±ê³¼ ë³´ê³ ì„œ</div>
            <span style="font-size:24px; cursor:pointer; color:#aaa;" onclick="document.getElementById('reportModal').style.display='none'">&times;</span>
        </div>
        <p style="color:#888; font-size:0.9rem; margin-top:0;">ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ì„œ ì¹´í†¡ì´ë‚˜ ë¬¸ì„œì— ë°”ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
        <textarea id="reportText" class="report-textarea"></textarea>
        <div style="text-align:center; margin-top:15px;">
             <button class="btn-style upload-btn" onclick="copyReport()"><i class="fa-regular fa-copy"></i> ì „ì²´ ë³µì‚¬</button>
        </div>
    </div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let db = [], filteredDb = [], monthList = new Set();
    let freeUserDb = []; 
    let keyboardDb = []; 
    let churnList = [], newList = [];
    let currentKpi = { amt:0, cnt:0 };

    // --- [íŒŒì¼ ì²˜ë¦¬ ë° íŒŒì‹±] ---
    
    function resetData() {
        if(confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            db = [];
            freeUserDb = []; 
            keyboardDb = []; 
            monthList.clear();
            document.getElementById('fileInput').value = '';
            document.getElementById('dashboard').style.display = 'none';
            alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.');
        }
    }

    function handleFiles(input) {
        const files = input.files;
        if (!files || files.length === 0) return;

        let loadedCount = 0;
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });
                    
                    processData(rows); 
                    
                    loadedCount++;
                    if(loadedCount === files.length) {
                        finalizeDataProcessing();
                    }
                } catch (err) { alert("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ ("+file.name+"): " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function finalizeDataProcessing() {
        populateFilter();
        updateDashboard();
        analyzeLTV();
        
        let msg = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ!\n- ë§¤ì¶œ ë‚´ì—­: ${db.length}ê±´\n- ë¬´ë£Œì²´í—˜: ${freeUserDb.length}ëª…`;
        if(keyboardDb.length > 0) msg += `\n- í‚¤ë³´ë“œ êµ¬ë§¤ì: ${keyboardDb.length}ëª…`;
        alert(msg);
    }

    // [ë¡œì§ ì—…ë°ì´íŠ¸] íŒŒì¼ ì¢…ë¥˜ ìë™ ê°ì§€
    function processData(rows) {
        if(!rows || rows.length < 2) return;

        let isGeneralSales = false;
        let isSingleRowSales = false; // [ì‹ ê·œ] ë‹¨ì¼í–‰ ì¼ë°˜ ë§¤ì¶œ í˜•ì‹ (ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼ í˜•íƒœ)
        let isPTSales = false;
        let isFreeUsers = false;
        let isKeyboard = false; 
        
        for(let i = 0; i < Math.min(rows.length, 5); i++) {
            let rowStr = rows[i].map(x => String(x || '')).join(' ');

            // ë‹¨ì¼í–‰ ì¼ë°˜ ë§¤ì¶œ í˜•ì‹ (ì‹ ì²­ì •ë³´, ì‹ ì²­ì, ê²°ì œê¸ˆì•¡ì´ í•œ ì¤„ì— ëª¨ë‘ ìˆëŠ” ê²½ìš°)
            if (rowStr.includes('ì‹ ì²­ì •ë³´') && rowStr.includes('ì‹ ì²­ì') && rowStr.includes('ê²°ì œê¸ˆì•¡')) {
                isSingleRowSales = true; break;
            } else if (rowStr.includes('ì‹ ì²­ì •ë³´') && rowStr.includes('ì„ íƒì •ë³´')) {
                isGeneralSales = true; break;
            } else if ((rowStr.includes('ì£¼ë¬¸ë²ˆí˜¸') || rowStr.includes('í•™ìƒëª…')) && !rowStr.includes('ìˆ˜ì—… ì—¬ë¶€') && !rowStr.includes('í‚¤ë³´ë“œ')) {
                isPTSales = true; break;
            } else if (rowStr.includes('ìˆ˜ì—… ì—¬ë¶€') || rowStr.includes('ì¿ í° ë§Œë£Œì¼')) {
                isFreeUsers = true; break;
            } else if (rowStr.includes('ì£¼ë¬¸ì¼') || rowStr.includes('êµ¬ë§¤ì¼') || rowStr.includes('ì†¡ì¥ë²ˆí˜¸')) {
                 isKeyboard = true; break;
            }
        }

        if (isSingleRowSales) {
            parseSingleRowSales(rows); // [ì‹ ê·œ] ë‹¨ì¼í–‰ íŒŒì„œ í˜¸ì¶œ
        } else if (isGeneralSales) {
            parseGeneralSales(rows);
        } else if (isPTSales) {
            parsePTSales(rows);
        } else if (isFreeUsers) {
            parseFreeUsers(rows);
        } else if (isKeyboard) {
            parseKeyboardUsers(rows); 
        }
    }

    // [ì‹ ê·œ] ë‹¨ì¼í–‰ ì¼ë°˜ ë§¤ì¶œ íŒŒì‹± í•¨ìˆ˜ (ì—…ë¡œë“œí•´ì£¼ì‹  CSV íŒŒì¼ í˜•íƒœ ì§€ì›)
    function parseSingleRowSales(rows) {
        let headerIdx = rows.findIndex(r => r.some(c => String(c).includes('ì‹ ì²­ì •ë³´') && String(c).includes('ì‹ ì²­ì')));
        if(headerIdx === -1) return;

        const headers = rows[headerIdx].map(x => String(x).trim());
        const colIdx = {
            date: headers.findIndex(h => h.includes('ì‹ ì²­ì •ë³´')),
            product: headers.findIndex(h => h.includes('ì„ íƒì •ë³´')),
            name: headers.findIndex(h => h.includes('ì‹ ì²­ì')),
            phone: headers.findIndex(h => h.includes('ì „í™”ë²ˆí˜¸')),
            price: headers.findIndex(h => h.includes('ê²°ì œê¸ˆì•¡')),
            status: headers.findIndex(h => h.includes('ê²°ì œìƒíƒœ'))
        };

        for (let i = headerIdx + 1; i < rows.length; i++) {
            let row = rows[i];
            if (!row || row.length <= colIdx.status || !row[colIdx.date]) continue;

            let status = String(row[colIdx.status]).trim();
            if (status === 'ê²°ì œì™„ë£Œ' || status.includes('ì·¨ì†Œ')) {
                let priceRaw = row[colIdx.price];
                let price = parseInt(String(priceRaw).replace(/[^\d]/g, '')) || 0;
                let dateObj = parseDate(row[colIdx.date]);
                let monthKey = getMonthKey(dateObj);
                
                if (!monthKey) continue;

                let productFull = String(row[colIdx.product]);
                let item = {
                    date: getDateStr(dateObj),
                    dateObj: dateObj,
                    month: monthKey,
                    name: String(row[colIdx.name]).trim(),
                    phone: cleanPhone(String(row[colIdx.phone])),
                    product: productFull,
                    price: price,
                    status: status,
                    option: productFull, // ë‹¨ì¼í–‰ì—ì„œëŠ” ì„ íƒì •ë³´ì— ì˜µì…˜ì´ ì´ë¯¸ í¬í•¨ë˜ì–´ ìˆìŒ
                    type: '', classInfo: '', dayInfo: '', timeInfo: '',
                    isPartial: false, isFullCancel: false
                };

                processItemType(item);
                db.push(item);
                monthList.add(monthKey);
            }
        }
    }

    // í‚¤ë³´ë“œ êµ¬ë§¤ì íŒŒì‹± í•¨ìˆ˜
    function parseKeyboardUsers(rows) {
        let headerIdx = rows.findIndex(r => r.some(c => String(c).includes('ì´ë¦„') || String(c).includes('êµ¬ë§¤ì')));
        if(headerIdx === -1) return;

        const headers = rows[headerIdx].map(x => String(x).trim());
        const colIdx = {
            name: headers.findIndex(h => h.includes('ì´ë¦„') || h.includes('êµ¬ë§¤ì') || h.includes('ì£¼ë¬¸ì')),
            phone: headers.findIndex(h => h.includes('ì—°ë½ì²˜') || h.includes('ì „í™”') || h.includes('í•¸ë“œí°')),
            date: headers.findIndex(h => h.includes('ì£¼ë¬¸ì¼') || h.includes('êµ¬ë§¤ì¼')),
            birth: headers.findIndex(h => h.includes('ìƒë…„') || h.includes('ì£¼ë¯¼') || h.includes('ìƒì¼')) 
        };

        if(colIdx.name === -1 || colIdx.phone === -1) return;

        for(let i = headerIdx + 1; i < rows.length; i++) {
            let row = rows[i];
            if(!row || !row[colIdx.name]) continue;

            let name = String(row[colIdx.name]).trim();
            let phone = cleanPhone(String(row[colIdx.phone]));
            let dateObj = parseDate(row[colIdx.date]);
            let birth = (colIdx.birth !== -1) ? String(row[colIdx.birth]).trim() : '';

            if(name && phone && dateObj) {
                keyboardDb.push({ 
                    name: name, 
                    phone: phone, 
                    date: dateObj, 
                    birth: birth 
                });
            }
        }
    }

    // ë¬´ë£Œ ì‚¬ìš©ì íŒŒì‹±
    function parseFreeUsers(rows) {
        let headerIdx = rows.findIndex(r => r.some(c => String(c).includes('ì„±ëª…') || String(c).includes('ì´ë¦„')));
        if(headerIdx === -1) return;

        const headers = rows[headerIdx].map(x => String(x).trim());
        const colIdx = {
            name: headers.findIndex(h => h === 'ì„±ëª…' || h === 'ì´ë¦„'),
            phone: headers.findIndex(h => h === 'í•¸ë“œí°' || h === 'ì—°ë½ì²˜' || h === 'ì „í™”ë²ˆí˜¸')
        };

        if(colIdx.name === -1 || colIdx.phone === -1) return;

        for(let i = headerIdx + 1; i < rows.length; i++) {
            let row = rows[i];
            if(!row || !row[colIdx.name]) continue;
            let name = String(row[colIdx.name]).trim();
            let phone = String(row[colIdx.phone]).trim();
            if(name && phone) {
                freeUserDb.push({ name: name, phone: cleanPhone(phone) });
            }
        }
    }

    // ì¼ë°˜ ë‹¤ì¤‘í–‰ ë§¤ì¶œ íŒŒì‹±
    function parseGeneralSales(rows) {
        let statusIdx = findStatusCol(rows);
        if(statusIdx === -1) return;

        let i = 0;
        while(i < rows.length) {
            let row = rows[i];
            if (!row || row.length < statusIdx) { i++; continue; }
            
            let status = String(row[statusIdx]).trim();
            if(status === 'ê²°ì œì™„ë£Œ' || status.includes('ì·¨ì†Œ')) {
                let priceRaw = row[statusIdx-1] || row[4]; 
                let price = parseInt(String(priceRaw).replace(/[^\d]/g, '')) || 0;
                let dateObj = parseDate(row[0]);
                let dateStr = getDateStr(dateObj); 
                let monthKey = getMonthKey(dateObj);
                
                if (!monthKey) { i++; continue; }

                let item = {
                    date: dateStr, dateObj: dateObj, month: monthKey, name: row[3], phone: '',
                    product: '', price: price, status: status, option: '',
                    type: '', classInfo: '', dayInfo: '', timeInfo: '', 
                    isPartial: false, isFullCancel: false
                };

                if(i+1 < rows.length) {
                    let rowB = rows[i+1];
                    item.product = String(rowB[1]);
                    item.phone = cleanPhone(String(rowB[3])); 
                    
                    let increment = 2;
                    if(i+2 < rows.length) {
                        let optInfo = String(rows[i+2][1]);
                        if(optInfo.includes('ì˜µì…˜')) {
                            item.option = optInfo;
                            increment = 3;
                        }
                    }
                    processItemType(item);
                    db.push(item);
                    if (monthKey) monthList.add(monthKey);
                    i += increment;
                } else { i++; }
            } else { i++; }
        }
    }

    // PT ë§¤ì¶œ íŒŒì‹±
    function parsePTSales(rows) {
        let headerIdx = rows.findIndex(r => r.some(c => String(c).includes('ì£¼ë¬¸ë²ˆí˜¸') || String(c).includes('í•™ìƒëª…')));
        if(headerIdx === -1) return;

        const headers = rows[headerIdx].map(x => String(x).trim());
        const colIdx = {
            date: headers.findIndex(h => h.includes('ì‹ ì²­ì¼') || h.includes('ê²°ì œì¼')),
            name: headers.findIndex(h => h === 'í•™ìƒëª…'),
            phone: headers.findIndex(h => h === 'ì—°ë½ì²˜'),
            product: headers.findIndex(h => h === 'ìƒí’ˆëª…'),
            price: headers.findIndex(h => h === 'ê²°ì œê¸ˆì•¡'),
            status: headers.findIndex(h => h === 'ê²°ì œìƒíƒœ')
        };

        for(let i = headerIdx + 1; i < rows.length; i++) {
            let row = rows[i];
            if(!row || !row[colIdx.price]) continue;

            let status = String(row[colIdx.status]).trim();
            if (status !== 'ê²°ì œì™„ë£Œ' && !status.includes('ì·¨ì†Œ')) continue;

            let price = parseInt(String(row[colIdx.price]).replace(/[^\d]/g, '')) || 0;
            let dateObj = parseDate(row[colIdx.date]);
            let dateStr = getDateStr(dateObj);
            let monthKey = getMonthKey(dateObj);

            if(!monthKey) continue;

            let item = {
                date: dateStr, dateObj: dateObj, month: monthKey, 
                name: String(row[colIdx.name]).trim(), 
                phone: cleanPhone(String(row[colIdx.phone])),
                product: String(row[colIdx.product]).trim(), 
                price: price, status: status, option: '',
                type: 'PT ì´ìš©ê¶Œ', classInfo: '', dayInfo: '', timeInfo: '',
                isPartial: false, isFullCancel: false
            };
            
            if(item.product.includes('íšŒê¶Œ')) item.type = 'PT ì´ìš©ê¶Œ';
            
            if(status.includes('ì·¨ì†Œ')) {
                 if (price >= 10000) item.isPartial = true;
                 else item.isFullCancel = true;
            }

            db.push(item);
            monthList.add(monthKey);
        }
    }

    function processItemType(item) {
        let isValid = false;
        if (item.status === 'ê²°ì œì™„ë£Œ') isValid = true;
        else if (item.status.includes('ì·¨ì†Œ') && item.price >= 10000) {
            isValid = true;
            item.isPartial = true;
        } else if (item.status.includes('ì·¨ì†Œ')) {
            item.isFullCancel = true;
        }

        if (isValid || item.isFullCancel) {
            if (item.type === 'PT ì´ìš©ê¶Œ') return;

            if (item.product.includes('ì˜¬íŒ¨ìŠ¤')) item.type = 'ì˜¬íŒ¨ìŠ¤';
            else if (item.product.includes('ì‹œí—˜ëŒ€ë¹„') && item.product.includes('ìë£Œ')) item.type = 'ì‹œí—˜ëŒ€ë¹„ë°˜ ìë£Œì´ìš©';
            else if (item.product.includes('ì‹œí—˜ëŒ€ë¹„')) item.type = 'ì‹œí—˜ëŒ€ë¹„ CLASS';
            else item.type = 'í™”ìƒìˆ˜ì—…';

            if (item.product.includes('ì‹œí—˜ëŒ€ë¹„') && !item.product.includes('ìë£Œ')) item.classInfo = 'ì‹œí—˜ëŒ€ë¹„ CLASS';
            else if (item.product.includes('ì…ë¬¸')) item.classInfo = 'ì…ë¬¸/ì¤‘ê¸‰ CLASS';
            else if (item.product.includes('ê³ ê¸‰')) item.classInfo = 'ê³ ê¸‰ CLASS';
            else if (item.product.includes('ì‹¬ì•¼')) item.classInfo = 'ì‹¬ì•¼ CLASS';
            else item.classInfo = '';

            let dM = item.option.match(/\[ìš”ì¼\]\s*([^,\]\n]+)/);
            if(dM) item.dayInfo = dM[1].trim();
            let tM = item.option.match(/\[ì‹œê°„\]\s*([^,\]\n]+)/);
            if(tM) {
                let tStr = tM[1].trim().replace(/[:ì‹œë¶„]/g, '').substring(0,2);
                if(!isNaN(parseInt(tStr))) item.timeInfo = parseInt(tStr);
            }
        }
    }

    function findStatusCol(rows) {
        for(let r=0; r<Math.min(rows.length, 50); r++) {
            for(let c=0; c<rows[r].length; c++) {
                if(String(rows[r][c]).includes('ê²°ì œìƒíƒœ')) return c;
            }
        }
        return 5;
    }

    function parseDate(raw) {
        if (!raw) return null;
        let str = String(raw).trim();
        if (!isNaN(str) && str.length < 6 && str.length > 4) {
            let date = new Date((Number(str) - (25567 + 2)) * 86400 * 1000);
            return date;
        }
        let cleanStr = str.replace(/[./]/g, '-').split(' ')[0];
        let date = new Date(cleanStr);
        if (!isNaN(date.getTime())) return date;
        return null;
    }

    function getMonthKey(dateObj) {
        if (!dateObj) return "";
        let y = dateObj.getFullYear();
        let m = String(dateObj.getMonth() + 1).padStart(2, '0');
        if(isNaN(y) || isNaN(m)) return "";
        return `${y}-${m}`;
    }

    function getDateStr(dateObj) {
        if (!dateObj) return "";
        let y = dateObj.getFullYear();
        let m = String(dateObj.getMonth() + 1).padStart(2, '0');
        let d = String(dateObj.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }
    
    function cleanPhone(str) {
        if(!str) return "";
        return str.replace(/[^\d]/g, '');
    }

    function populateFilter() {
        const sel = document.getElementById('monthFilter');
        sel.innerHTML = '<option value="all">ğŸ“… ì „ì²´ ê¸°ê°„ ë³´ê¸°</option>';
        let list = Array.from(monthList).sort().reverse();
        list.forEach(m => { if(m) sel.innerHTML += `<option value="${m}">${m}ì›” ë§¤ì¶œ</option>`; });
    }

    // --- [ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ & ë¶„ì„ ë¡œì§] ---

    function updateDashboard() {
        const mon = document.getElementById('monthFilter').value;
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('trendSection').style.display = (mon === 'all') ? 'block' : 'none';
        document.getElementById('insightSection').style.display = (mon === 'all') ? 'none' : 'block';

        if(mon === 'all') {
            filteredDb = db;
            document.getElementById('kpiTitle').innerText = 'ğŸ’° ì „ì²´ ëˆ„ì  ë§¤ì¶œ í˜„í™©';
            renderTrend(); 
        } else {
            filteredDb = db.filter(i => i.month === mon);
            document.getElementById('kpiTitle').innerText = `ğŸ’° ${mon}ì›” ë§¤ì¶œ í˜„í™©`;
        }
        analyze(filteredDb, mon);
        calculateGoal();
        
        if(freeUserDb.length > 0) analyzeConversion();
        if(keyboardDb.length > 0) {
            document.getElementById('keyboardSection').style.display = 'block';
            analyzeKeyboardConversion(); 
        } else {
             document.getElementById('keyboardSection').style.display = 'none';
        }
    }

    function analyzeKeyboardConversion() {
        let totalKb = keyboardDb.length;
        let converted = [];
        let timeToConvert = []; 
        let firstClassStats = {}; 
        let ageStats = {}; 
        
        let payMap = {};
        db.forEach(item => {
            if(!item.isFullCancel && item.phone) {
                if(!payMap[item.phone]) payMap[item.phone] = [];
                payMap[item.phone].push(item);
            }
        });
        
        Object.keys(payMap).forEach(key => {
            payMap[key].sort((a,b) => a.dateObj - b.dateObj);
        });

        keyboardDb.forEach(kb => {
            let userPays = payMap[kb.phone];
            if(userPays && userPays.length > 0) {
                let firstPay = userPays.find(p => p.dateObj >= kb.date);
                
                if(firstPay) {
                    let diffTime = Math.abs(firstPay.dateObj - kb.date);
                    let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    
                    converted.push({
                        name: kb.name,
                        buyDate: getDateStr(kb.date),
                        firstClassDate: getDateStr(firstPay.dateObj),
                        diffDays: diffDays,
                        firstClass: firstPay.type + (firstPay.classInfo ? ` (${firstPay.classInfo})` : '')
                    });

                    timeToConvert.push(diffDays);
                    
                    let cType = firstPay.type;
                    if(cType.includes('PT')) cType = 'PT';
                    else if(cType.includes('ì˜¬íŒ¨ìŠ¤')) cType = 'ì˜¬íŒ¨ìŠ¤';
                    else if(cType.includes('ì‹œí—˜ëŒ€ë¹„')) cType = 'ì‹œí—˜ëŒ€ë¹„ë°˜';
                    else cType = 'ì •ê·œ í™”ìƒìˆ˜ì—…';
                    
                    firstClassStats[cType] = (firstClassStats[cType] || 0) + 1;

                    if(kb.birth) {
                        let bStr = String(kb.birth).trim().replace(/[^0-9]/g, ''); 
                        let fullYear = 0;

                        if(bStr.length === 4) {
                            fullYear = parseInt(bStr);
                        }
                        else if(bStr.length >= 2) {
                            let yPrefix = parseInt(bStr.substring(0,2));
                            fullYear = (yPrefix > 30) ? 1900 + yPrefix : 2000 + yPrefix;
                        }

                        if(fullYear > 0) {
                            let currentYear = new Date().getFullYear();
                            let age = currentYear - fullYear + 1; 
                            let ageGroup = Math.floor(age / 10) * 10 + 'ëŒ€';
                            ageStats[ageGroup] = (ageStats[ageGroup] || 0) + 1;
                        } else {
                            ageStats['ë¯¸í™•ì¸'] = (ageStats['ë¯¸í™•ì¸'] || 0) + 1;
                        }
                    } else {
                        ageStats['ë¯¸í™•ì¸'] = (ageStats['ë¯¸í™•ì¸'] || 0) + 1;
                    }
                }
            }
        });

        document.getElementById('kbTotal').innerText = totalKb + "ëª…";
        document.getElementById('kbSuccess').innerText = converted.length + "ëª…";
        let rate = totalKb > 0 ? ((converted.length / totalKb) * 100).toFixed(1) : 0;
        document.getElementById('kbRate').innerText = rate + "%";
        
        let avgDays = timeToConvert.length > 0 ? (timeToConvert.reduce((a,b)=>a+b,0) / timeToConvert.length).toFixed(0) : 0;
        document.getElementById('kbAvgDays').innerText = avgDays + "ì¼";

        let timeDist = {'1ì£¼ ì´ë‚´':0, '1ë‹¬ ì´ë‚´':0, '3ë‹¬ ì´ë‚´':0, '3ë‹¬ ì´í›„':0};
        timeToConvert.forEach(d => {
            if(d <= 7) timeDist['1ì£¼ ì´ë‚´']++;
            else if(d <= 30) timeDist['1ë‹¬ ì´ë‚´']++;
            else if(d <= 90) timeDist['3ë‹¬ ì´ë‚´']++;
            else timeDist['3ë‹¬ ì´í›„']++;
        });
        renderChart('chartKbTime', fromObjToArr(timeDist), 'ì¸ì›', false, ['#ffb7b2', '#ffdac1', '#e2f0cb', '#b5ead7']);
        renderChart('chartKbClass', fromObjToArr(firstClassStats), 'ì¸ì›', false, ['#a2c2ff', '#95e1d3', '#ff9aa2', '#e0bbe4']);

        let ageClean = {};
        Object.keys(ageStats).forEach(k => { if(k !== 'ë¯¸í™•ì¸') ageClean[k] = ageStats[k]; });
        if(Object.keys(ageClean).length > 0) {
             renderChart('chartKbAge', fromObjToArr(ageClean), 'ì¸ì›', true, ['#ffd700', '#ffb7b2', '#a2c2ff', '#95e1d3']);
        } else {
             renderChart('chartKbAge', [], 'ì¸ì›', false);
        }

        let tb = document.querySelector('#tableKbConversion tbody');
        tb.innerHTML = '';
        converted.forEach(u => {
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.name}</td><td>${u.buyDate}</td><td style="color:#ff6f91;font-weight:bold;">${u.firstClassDate}</td><td>${u.diffDays}ì¼</td><td>${u.firstClass}</td>`;
            tb.appendChild(tr);
        });
    }

    function fromObjToArr(obj) {
        let wrapper = {};
        Object.keys(obj).forEach(k => {
            wrapper[k] = { cnt: obj[k], amt: 0, list: [] };
        });
        return wrapper;
    }
    
    function analyzeConversion() {
        if (freeUserDb.length === 0) return;

        let convertedList = [];
        let detailStats = {
            'ì˜¬íŒ¨ìŠ¤': 0, 'ì‹œëŒ€ë°˜(ì‹œí—˜ëŒ€ë¹„)': 0, 'í¼ìŠ¤ë„í´ë˜ìŠ¤(PT)': 0,
            'í™”ìƒìˆ˜ì—…(ì…ë¬¸/ì¤‘ê¸‰)': 0, 'í™”ìƒìˆ˜ì—…(ê³ ê¸‰)': 0, 'í™”ìƒìˆ˜ì—…(ì‹¬ì•¼)': 0, 'ê¸°íƒ€': 0
        };

        let payHistory = {};
        db.forEach(item => {
            if (!item.isFullCancel && item.phone) {
                if (!payHistory[item.phone]) payHistory[item.phone] = [];
                payHistory[item.phone].push(item);
            }
        });

        freeUserDb.forEach(freeUser => {
            if (freeUser.phone && payHistory[freeUser.phone]) {
                let userCategories = new Set(); 
                payHistory[freeUser.phone].forEach(payItem => {
                    let cat = 'ê¸°íƒ€';
                    if (payItem.type === 'ì˜¬íŒ¨ìŠ¤') cat = 'ì˜¬íŒ¨ìŠ¤';
                    else if (payItem.type === 'PT ì´ìš©ê¶Œ') cat = 'í¼ìŠ¤ë„í´ë˜ìŠ¤(PT)';
                    else if (payItem.type.includes('ì‹œí—˜ëŒ€ë¹„')) cat = 'ì‹œëŒ€ë°˜(ì‹œí—˜ëŒ€ë¹„)';
                    else if (payItem.type === 'í™”ìƒìˆ˜ì—…') {
                        if (payItem.classInfo.includes('ì…ë¬¸') || payItem.classInfo.includes('ì¤‘ê¸‰')) cat = 'í™”ìƒìˆ˜ì—…(ì…ë¬¸/ì¤‘ê¸‰)';
                        else if (payItem.classInfo.includes('ê³ ê¸‰')) cat = 'í™”ìƒìˆ˜ì—…(ê³ ê¸‰)';
                        else if (payItem.classInfo.includes('ì‹¬ì•¼')) cat = 'í™”ìƒìˆ˜ì—…(ì‹¬ì•¼)';
                    }
                    userCategories.add(cat);
                });
                
                let repProduct = Array.from(userCategories)[0] || 'ê¸°íƒ€';
                convertedList.push({ ...freeUser, repProduct: repProduct });

                userCategories.forEach(c => {
                    if (detailStats[c] !== undefined) detailStats[c]++;
                    else detailStats['ê¸°íƒ€']++;
                });
            }
        });

        let totalFree = freeUserDb.length;
        let convertedCount = convertedList.length;
        let rate = totalFree > 0 ? ((convertedCount / totalFree) * 100).toFixed(1) : 0;

        document.getElementById('convTotal').innerText = totalFree + 'ëª…';
        document.getElementById('convSuccess').innerText = convertedCount + 'ëª…';
        document.getElementById('convRate').innerText = rate + '%';

        let ctx1 = document.getElementById('chartConversion').getContext('2d');
        if (Chart.getChart('chartConversion')) Chart.getChart('chartConversion').destroy();
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['ë¯¸ì „í™˜', 'ìœ ë£Œ ì „í™˜'],
                datasets: [{
                    data: [totalFree - convertedCount, convertedCount],
                    backgroundColor: ['#f0f0f0', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '60%' }
        });

        let ctx2 = document.getElementById('chartConversionDetail').getContext('2d');
        if (Chart.getChart('chartConversionDetail')) Chart.getChart('chartConversionDetail').destroy();
        
        let detailLabels = [];
        let detailData = [];
        Object.keys(detailStats).forEach(k => {
            if(detailStats[k] > 0) {
                detailLabels.push(k);
                detailData.push(detailStats[k]);
            }
        });

        new Chart(ctx2, {
            type: 'pie', 
            data: {
                labels: detailLabels,
                datasets: [{
                    data: detailData,
                    backgroundColor: ['#ffb7b2', '#ffd700', '#a2c2ff', '#95e1d3', '#e0bbe4', '#ffdac1', '#c7ceea'],
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                }
            }
        });

        let tb = document.querySelector('#tableConversion tbody');
        tb.innerHTML = '';
        convertedList.forEach(u => {
            let tr = document.createElement('tr');
            let fmtPhone = u.phone.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            tr.innerHTML = `<td>${u.name}</td><td>${fmtPhone}</td><td>${u.repProduct}</td><td class="clickable-row">í™•ì¸</td>`;
            tr.onclick = () => {
                let userPayList = db.filter(p => p.phone === u.phone);
                showList(`${u.name}ë‹˜ì˜ ì „í™˜ ë‚´ì—­`, 'list', userPayList);
            };
            tb.appendChild(tr);
        });
    }

    function analyze(data, currentMon) {
        let kpi = { amt:0, cnt:0, cancelCnt:0 };
        let cats = { type:{}, class:{}, day:{}, time:{} };
        let hm = { 'ì›”':{}, 'í™”':{}, 'ìˆ˜':{}, 'ëª©':{}, 'ê¸ˆ':{}, 'í† ':{}, 'ì¼':{} };
        let stu = {};

        data.forEach(i => {
            if(i.isFullCancel) { kpi.cancelCnt++; return; }
            kpi.amt += i.price;
            kpi.cnt++;

            addCnt(cats.type, i.type, i);

            if(i.type !== 'ì˜¬íŒ¨ìŠ¤' && i.type !== 'PT ì´ìš©ê¶Œ') {
                addCnt(cats.class, i.classInfo, i);
                addCnt(cats.day, i.dayInfo, i);
                if(i.timeInfo !== '') addCnt(cats.time, i.timeInfo + 'ì‹œ', i);
                if(i.dayInfo && i.timeInfo !== '') {
                    i.dayInfo.split('').forEach(d => {
                        if(hm[d]) {
                            let t = i.timeInfo;
                            if(!hm[d][t]) hm[d][t] = {cnt:0, list:[]};
                            hm[d][t].cnt++;
                            hm[d][t].list.push(i);
                        }
                    });
                }
            }
            
            let key = i.phone || i.name;
            if(!stu[key]) stu[key] = {name:i.name, phone:i.phone, amt:0, cnt:0, list:[]};
            stu[key].amt += i.price;
            stu[key].cnt++;
            stu[key].list.push(i);
        });

        currentKpi = kpi; 

        if (currentMon !== 'all') {
            const uniqueStudents = Object.keys(stu);
            const uniqueCount = uniqueStudents.length;

            const arpu = uniqueCount > 0 ? Math.round(kpi.amt / uniqueCount) : 0;
            document.getElementById('insightArpu').innerText = arpu.toLocaleString() + 'ì›';

            let [y, m] = currentMon.split('-').map(Number);
            let prevDate = new Date(y, m - 2, 1);
            let prevMon = getMonthKey(prevDate);
            
            let prevMonthStudents = new Set();
            db.filter(i => i.month === prevMon && !i.isFullCancel)
              .forEach(i => prevMonthStudents.add(i.phone || i.name));
            
            let reRegCount = 0;
            uniqueStudents.forEach(k => { if(prevMonthStudents.has(k)) reRegCount++; });
            const retentionRate = prevMonthStudents.size > 0 ? Math.round((reRegCount / prevMonthStudents.size) * 100) : 0;
            document.getElementById('insightRetention').innerText = retentionRate + '%';

            let totalPastStudents = new Set();
            db.filter(i => i.month < currentMon && !i.isFullCancel)
              .forEach(i => totalPastStudents.add(i.phone || i.name));
            
            newList = uniqueStudents.filter(k => !totalPastStudents.has(k)).map(k => stu[k]);
            document.getElementById('insightNew').innerText = newList.length + 'ëª…';
            
            let churnKeys = Array.from(prevMonthStudents).filter(k => !stu[k]);
            churnList = churnKeys.map(k => {
                let lastInfo = db.filter(i => (i.phone || i.name) === k).pop();
                return { name: lastInfo.name, phone: lastInfo.phone, product: 'ì „ì›” ìˆ˜ê°•ìƒ(ë¯¸ë“±ë¡)', price: 0, date: lastInfo.date };
            });
            document.getElementById('insightChurn').innerText = churnList.length + 'ëª…';
        }

        document.getElementById('kpiTotalAmt').innerText = kpi.amt.toLocaleString() + 'ì›';
        document.getElementById('kpiTotalCnt').innerText = kpi.cnt + 'ê±´';
        document.getElementById('kpiCancelCnt').innerText = kpi.cancelCnt + 'ê±´';
        
        const pastelColors = ['#a2c2ff', '#95e1d3', '#ffb7b2', '#e2f0cb', '#b5ead7', '#c7ceea', '#ffdac1', '#e0bbe4', '#f9f9f9'];
        renderChart('chartType', cats.type, 'ë§¤ì¶œ', false, pastelColors);
        renderChart('chartClass', cats.class, 'ë§¤ì¶œ', false, pastelColors);
        renderChart('chartDay', cats.day, 'ì¸ì›', false, pastelColors);
        renderChart('chartTime', cats.time, 'ì¸ì›', true, pastelColors);
        renderTable('tableType', cats.type, 'ë§¤ì¶œ');
        renderTable('tableClass', cats.class, 'ë§¤ì¶œ');
        renderTable('tableDay', cats.day, 'ì¸ì›');
        renderTable('tableTime', cats.time, 'ì¸ì›', true); 
        renderHeatmap(hm);
        renderVip(stu);
    }

    function analyzeLTV() {
        if(db.length === 0) return;
        
        let stuMap = {};
        db.forEach(i => {
            if(i.isFullCancel) return;
            let key = i.phone || i.name;
            if(!stuMap[key]) stuMap[key] = { months: new Set() };
            stuMap[key].months.add(i.month);
        });

        let counts = { '1ê°œì›”(ì‹ ê·œ/ë‹¨ë°œ)': 0, '2~3ê°œì›”(ìœ ì§€)': 0, '4~6ê°œì›”(ì¥ê¸°)': 0, '7ê°œì›” ì´ìƒ(VIP)': 0 };
        let totalMonths = 0;
        let totalStudents = 0;

        Object.values(stuMap).forEach(s => {
            let n = s.months.size;
            totalMonths += n;
            totalStudents++;
            if(n === 1) counts['1ê°œì›”(ì‹ ê·œ/ë‹¨ë°œ)']++;
            else if(n <= 3) counts['2~3ê°œì›”(ìœ ì§€)']++;
            else if(n <= 6) counts['4~6ê°œì›”(ì¥ê¸°)']++;
            else counts['7ê°œì›” ì´ìƒ(VIP)']++;
        });

        let avg = totalStudents > 0 ? (totalMonths / totalStudents).toFixed(1) : 0;
        document.getElementById('ltvTotalStudents').innerText = totalStudents.toLocaleString() + 'ëª…';
        document.getElementById('ltvAvgDuration').innerText = avg + 'ê°œì›”';

        let ctx = document.getElementById('chartLtv').getContext('2d');
        if(Chart.getChart('chartLtv')) Chart.getChart('chartLtv').destroy();
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts),
                    backgroundColor: ['#ffb7b2', '#ffd700', '#95e1d3', '#a2c2ff']
                }]
            },
            options: { responsive:true, maintainAspectRatio:false }
        });
    }

    function inputNumberFormat(obj) {
        obj.value = comma(uncomma(obj.value));
    }
    function comma(str) {
        str = String(str);
        return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
    }
    function uncomma(str) {
        str = String(str);
        return str.replace(/[^\d]+/g, '');
    }

    function calculateGoal() {
        const input = document.getElementById('targetInput').value;
        const target = parseInt(uncomma(input));
        const current = currentKpi.amt;
        const bar = document.getElementById('goalProgressBar');
        const confetti = document.getElementById('goalConfetti');

        if (!target || target === 0) {
            bar.style.width = '0%';
            bar.innerText = 'ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            return;
        }

        let percent = Math.min(100, Math.round((current / target) * 100));
        bar.style.width = percent + '%';
        bar.innerText = percent + '% ë‹¬ì„±';

        if (percent >= 100) {
            bar.style.background = 'linear-gradient(90deg, #10b981, #6ee7b7)';
            confetti.style.display = 'block';
        } else {
            bar.style.background = 'linear-gradient(90deg, #a2c2ff, #95e1d3)';
            confetti.style.display = 'none';
        }
    }

    function openCompareModal() {
        if(monthList.size < 2) { alert("ë¹„êµí•  ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (2ê°œì›” ì´ìƒ í•„ìš”)"); return; }
        
        const selA = document.getElementById('compA');
        const selB = document.getElementById('compB');
        selA.innerHTML = ''; selB.innerHTML = '';
        
        let list = Array.from(monthList).sort().reverse();
        list.forEach(m => {
            selA.innerHTML += `<option value="${m}">${m}</option>`;
            selB.innerHTML += `<option value="${m}">${m}</option>`;
        });
        if(list.length >= 2) selB.selectedIndex = 1; 

        document.getElementById('compareModal').style.display = 'flex';
        document.getElementById('compareResult').style.display = 'none';
    }

    function doCompare() {
        const mA = document.getElementById('compA').value;
        const mB = document.getElementById('compB').value;
        
        if(mA === mB) { alert("ì„œë¡œ ë‹¤ë¥¸ ë‹¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        const dataA = db.filter(i => i.month === mA && !i.isFullCancel);
        const dataB = db.filter(i => i.month === mB && !i.isFullCancel);

        const sumA = dataA.reduce((sum, i) => sum + i.price, 0);
        const sumB = dataB.reduce((sum, i) => sum + i.price, 0);
        const diff = sumA - sumB;

        document.getElementById('compLabelA').innerText = mA + 'ì›” ë§¤ì¶œ';
        document.getElementById('compLabelB').innerText = mB + 'ì›” ë§¤ì¶œ';
        document.getElementById('compValA').innerText = sumA.toLocaleString() + 'ì›';
        document.getElementById('compValB').innerText = sumB.toLocaleString() + 'ì›';
        
        const diffEl = document.getElementById('compDiff');
        diffEl.innerText = (diff > 0 ? 'â–² ' : 'â–¼ ') + Math.abs(diff).toLocaleString() + 'ì›';
        diffEl.className = diff > 0 ? 'delta-pos' : 'delta-neg';

        document.getElementById('compareResult').style.display = 'block';

        let ctx = document.getElementById('chartCompare').getContext('2d');
        if(Chart.getChart('chartCompare')) Chart.getChart('chartCompare').destroy();
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ë§¤ì¶œì•¡'],
                datasets: [
                    { label: mA, data: [sumA], backgroundColor: '#a2c2ff' },
                    { label: mB, data: [sumB], backgroundColor: '#ffb7b2' }
                ]
            },
            options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
        });
    }

    function generateReport() {
        const mon = document.getElementById('monthFilter').value;
        if(mon === 'all') { alert("íŠ¹ì • ì›”ì„ ì„ íƒí•œ í›„ ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”."); return; }

        let txt = `[ ğŸ“¢ ${mon}ì›” ì•„ì¹´ë°ë¯¸ ìš´ì˜ ì„±ê³¼ ë³´ê³  ]\n\n`;
        
        txt += `1. ë§¤ì¶œ ìš”ì•½\n`;
        txt += `- ì´ ë§¤ì¶œì•¡: ${currentKpi.amt.toLocaleString()}ì›\n`;
        txt += `- ê²°ì œ ê±´ìˆ˜: ${currentKpi.cnt}ê±´\n`;
        txt += `- ê°ë‹¨ê°€: ${document.getElementById('insightArpu').innerText}\n\n`;

        txt += `2. ìˆ˜ê°•ìƒ í˜„í™©\n`;
        txt += `- ì‹ ê·œ ìœ ì…: ${document.getElementById('insightNew').innerText}\n`;
        txt += `- ì¬ë“±ë¡ë¥ : ${document.getElementById('insightRetention').innerText}\n`;
        txt += `- ì´íƒˆ ì˜ì‹¬: ${document.getElementById('insightChurn').innerText} (ì¬ë“±ë¡ ë…ë ¤ í•„ìš”)\n\n`;

        let classSums = {};
        filteredDb.forEach(i => { if(!i.isFullCancel && i.type) classSums[i.type] = (classSums[i.type]||0)+i.price; });
        let topClass = Object.keys(classSums).sort((a,b) => classSums[b]-classSums[a])[0] || 'ì—†ìŒ';
        
        txt += `3. ì£¼ìš” ì‚¬í•­\n`;
        txt += `- ì´ë²ˆ ë‹¬ íš¨ì ìƒí’ˆ(ìœ í˜•)ì€ '${topClass}' ì…ë‹ˆë‹¤.\n`;
        txt += `- í™˜ë¶ˆ ê±´ìˆ˜ëŠ” ì´ ${currentKpi.cancelCnt}ê±´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n`;

        if(freeUserDb.length > 0) {
            txt += `\n4. ë¬´ë£Œì²´í—˜ ì „í™˜ìœ¨\n`;
            txt += `- ì´ ì²´í—˜ ì¸ì›: ${document.getElementById('convTotal').innerText}\n`;
            txt += `- ìœ ë£Œ ì „í™˜: ${document.getElementById('convSuccess').innerText} (${document.getElementById('convRate').innerText})\n`;
        }
        
        if(keyboardDb.length > 0) {
             txt += `\n5. í‚¤ë³´ë“œ êµ¬ë§¤ì ë¶„ì„\n`;
             txt += `- êµ¬ë§¤ì ì¤‘ ìˆ˜ê°•ì „í™˜: ${document.getElementById('kbRate').innerText}\n`;
             txt += `- í‰ê·  ë“±ë¡ ì†Œìš”: ${document.getElementById('kbAvgDays').innerText}\n`;
        }

        document.getElementById('reportText').value = txt;
        document.getElementById('reportModal').style.display = 'flex';
    }

    function copyReport() {
        const el = document.getElementById('reportText');
        el.select();
        document.execCommand('copy');
        alert("ë³´ê³ ì„œ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function addCnt(obj, key, item) {
        if(!key) return;
        if(!obj[key]) obj[key] = {amt:0, cnt:0, list:[]};
        obj[key].amt += item.price;
        obj[key].cnt++;
        obj[key].list.push(item);
    }

    function renderTrend() {
        let monthly = {};
        db.forEach(i => { if(!i.isFullCancel) monthly[i.month] = (monthly[i.month]||0) + i.price; });
        let keys = Object.keys(monthly).sort();
        let vals = keys.map(k => monthly[k]);
        let ctx = document.getElementById('chartTrend').getContext('2d');
        if(Chart.getChart('chartTrend')) Chart.getChart('chartTrend').destroy();
        new Chart(ctx, {
            type: 'line',
            data: { labels: keys, datasets: [{ 
                label:'ì›”ë§¤ì¶œ', data:vals, 
                borderColor:'#8cb6ff', backgroundColor:'rgba(162, 194, 255, 0.2)',
                pointBackgroundColor: '#fff', pointBorderColor: '#8cb6ff', pointRadius: 5,
                fill:true, tension: 0.3 
            }] },
            options: { 
                responsive:true, maintainAspectRatio:false,
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { borderDash: [5, 5], color: '#f0f0f0' } }
                }
            }
        });
    }

    function renderChart(id, obj, metric, isTimeSort=false, colors) {
        let keys = Object.keys(obj);
        if(isTimeSort) keys.sort((a,b) => parseInt(a) - parseInt(b));
        else keys.sort((a,b) => metric==='ë§¤ì¶œ'?obj[b].amt-obj[a].amt : obj[b].cnt-obj[a].cnt);

        let vals = keys.map(k => metric==='ë§¤ì¶œ'?obj[k].amt : obj[k].cnt);
        let ctx = document.getElementById(id).getContext('2d');
        if(Chart.getChart(id)) Chart.getChart(id).destroy();
        new Chart(ctx, {
            type: metric==='ë§¤ì¶œ'?'doughnut':'bar',
            data: { 
                labels: keys, 
                datasets: [{ 
                    label:metric, data:vals, 
                    backgroundColor: colors || ['#3b82f6','#10b981'],
                    borderRadius: 5, borderWidth: 0
                }] 
            },
            options: { 
                responsive:true, maintainAspectRatio:false,
                onClick: (e, els) => { if(els.length>0) showList(keys[els[0].index], 'list', obj[keys[els[0].index]].list); },
                scales: metric==='ë§¤ì¶œ' ? {} : {
                    x: { grid: { display: false } },
                    y: { grid: { borderDash: [5, 5], color: '#f0f0f0' } }
                }
            }
        });
    }

    function renderTable(id, obj, metric, isTimeSort=false) {
        let tb = document.querySelector(`#${id} tbody`);
        tb.innerHTML = '';
        let keys = Object.keys(obj);
        if(isTimeSort) keys.sort((a,b) => parseInt(a) - parseInt(b));
        else keys.sort((a,b) => metric==='ë§¤ì¶œ'?obj[b].amt-obj[a].amt : obj[b].cnt-obj[a].cnt);
        keys.forEach(k => {
            let tr = document.createElement('tr');
            let val = metric==='ë§¤ì¶œ'?obj[k].amt.toLocaleString()+'ì›' : obj[k].cnt+'ëª…';
            tr.innerHTML = metric==='ë§¤ì¶œ' ? `<td>${k}</td><td>${val}</td><td>${obj[k].cnt}ê±´</td><td class="clickable-row">í™•ì¸</td>` : `<td>${k}</td><td>${val}</td><td class="clickable-row">í™•ì¸</td>`;
            tr.onclick = () => showList(k, 'list', obj[k].list);
            tb.appendChild(tr);
        });
    }

    function renderHeatmap(hm) {
        const times = [9,10,11,14,15,16,17,19,20,21];
        const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
        let html = '<table class="heatmap-table"><thead><tr><th></th>';
        times.forEach(t=>html+=`<th>${t}</th>`);
        html+='</tr></thead><tbody>';
        let max = 0;
        days.forEach(d=>times.forEach(t=>{ if(hm[d][t] && hm[d][t].cnt>max) max = hm[d][t].cnt; }));
        days.forEach(d=>{
            html+=`<tr><th>${d}</th>`;
            times.forEach(t=>{
                let cnt = hm[d][t] ? hm[d][t].cnt : 0;
                let alpha = max > 0 ? cnt/max : 0;
                let bg = cnt>0 ? `rgba(255, 183, 178, ${Math.max(0.15, alpha)})` : '#fdfdfd';
                let col = (alpha > 0.6) ? '#fff' : '#666';
                let border = cnt>0 ? 'border:1px solid #ffdeda;' : '';
                html+=`<td class="heatmap-cell" style="background:${bg};color:${col};${border}" onclick='showList("${d} ${t}ì‹œ","list", ${JSON.stringify(hm[d][t]?hm[d][t].list:[])})'>${cnt||'-'}</td>`;
            });
            html+='</tr>';
        });
        document.getElementById('heatmapArea').innerHTML = html+'</tbody></table>';
    }

    function renderVip(stu) {
        let list = Object.values(stu).sort((a,b)=>b.amt-a.amt).slice(0,10);
        let tb = document.querySelector('#tableVip tbody');
        tb.innerHTML = '';
        list.forEach((s,i)=>{
            let tr = document.createElement('tr');
            tr.innerHTML = `<td><span class="rank-badge ${i<3?'rank-'+(i+1):''}">${i+1}</span></td><td style="font-weight:bold;">${s.name}</td><td>${s.amt.toLocaleString()}</td><td>${s.cnt}</td><td class="clickable-row">í™•ì¸</td>`;
            tr.onclick = () => showList(s.name, 'list', s.list);
            tb.appendChild(tr);
        });
        let rev = Object.values(stu).filter(s=>s.cnt>=2).sort((a,b)=>b.cnt-a.cnt).slice(0,10);
        let tb2 = document.querySelector('#tableRevisit tbody');
        tb2.innerHTML = '';
        rev.forEach(s=>{
            let tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.name}</td><td>${s.phone}</td><td>${s.cnt}íšŒ</td><td>${s.amt.toLocaleString()}</td><td class="clickable-row">í™•ì¸</td>`;
            tr.onclick = () => showList(s.name, 'list', s.list);
            tb2.appendChild(tr);
        });
    }

    function showList(title, type, list=[]) {
        let tList = list;
        if(type==='valid_sales') tList = filteredDb.filter(i=>!i.isFullCancel);
        if(type==='full_cancel') tList = filteredDb.filter(i=>i.isFullCancel);
        
        document.getElementById('modalTitle').innerText = `${title} (${tList.length}ëª…)`;
        let html = '';
        tList.forEach(i=>{
            let badge = i.isPartial ? '<span class="badge-partial">ì¤‘ë„í™˜ë¶ˆ</span>' : '';
            html += `<div class="student-item">
                <div><b>${i.name}</b> ${badge} <span style="color:#888;font-size:12px">${i.product} (${i.price.toLocaleString()}ì›)</span></div>
                <div>${i.phone} <span style="font-size:11px;color:#aaa">${i.date}</span></div>
            </div>`;
        });
        document.getElementById('modalList').innerHTML = html;
        document.getElementById('studentModal').style.display = 'flex';
    }
    
    function showInsightList(title, type) {
        let list = (type === 'new') ? newList : churnList;
        showList(title, 'list', list);
    }

    function copyList() {
        let txt = "";
        document.querySelectorAll('.student-item').forEach(div=>{
            txt += `${div.children[0].innerText}\t${div.children[1].innerText}\n`;
        });
        navigator.clipboard.writeText(txt).then(()=>alert('ëª…ë‹¨ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!'));
    }
</script>
</body>
</html>
