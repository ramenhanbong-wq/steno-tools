<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†ê¸° ë“€ì–¼ ë§ˆìŠ¤í„° (ìµœì¢…_6ë‹¨ë½_ì™„ë²½ìˆ˜ì •)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-cream: #fdfbf7;
            --card-white: #ffffff;
            --theme-pink: #ffb7b2;
            --theme-mint: #95e1d3;
            --theme-deep: #5d5d5d;
            --border-line: #f0ebeb;
            --text-main: #4a4a4a;
        }

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-cream);
            color: var(--text-main);
            margin: 0; padding-top: 80px; padding-bottom: 50px;
        }

        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #eee; display: flex; align-items: center;
            justify-content: space-between; padding: 0 30px; box-sizing: border-box; z-index: 1000;
        }
        .logo { font-family: 'Gowun Dodum'; font-weight: bold; font-size: 1.2rem; color: #555; text-decoration: none; }
        
        .container {
            max-width: 1400px; margin: 0 auto; padding: 20px;
        }

        .control-panel {
            background: white; border-radius: 20px; padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px;
            border: 1px solid var(--border-line);
        }

        .input-wrapper { display: flex; gap: 20px; margin-bottom: 20px; }
        .raw-input {
            flex: 1; height: 100px; padding: 15px; border-radius: 10px;
            border: 2px solid #eee; resize: vertical; font-size: 16px;
            font-family: 'Pretendard'; outline: none; transition: 0.2s;
        }
        .raw-input:focus { border-color: var(--theme-pink); background: #fffafa; }

        .settings-bar {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
            background: #f8f9fa; padding: 15px; border-radius: 12px;
        }
        
        .setting-group { display: flex; align-items: center; gap: 8px; font-size: 0.95rem; font-weight: bold; color: #555; margin-right: 15px; }
        .setting-group input {
            width: 70px; padding: 8px; border: 1px solid #ddd; border-radius: 8px;
            text-align: center; font-weight: bold;
        }

        .btn {
            padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer;
            font-weight: bold; font-family: 'Gowun Dodum'; transition: 0.2s;
            display: flex; align-items: center; gap: 6px; font-size: 0.95rem;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(0.95); }

        .btn-dict { background: #eee; color: #555; }
        .btn-reset { background: #6c757d; color: white; }
        .btn-start { background: var(--theme-pink); color: white; }
        .btn-redo { background: var(--theme-mint); color: white; }
        .btn-copy { background: var(--theme-deep); color: white; margin-left: auto; }

        .dual-view-header {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px;
        }
        .col-header {
            text-align: center; padding: 10px; border-radius: 10px; font-weight: bold; font-family: 'Gowun Dodum';
        }
        .header-pink { background: #fff0f0; color: #e85d5d; border: 1px solid #ffdbd9; }
        .header-mint { background: #e8f7f4; color: #2d5a50; border: 1px solid #d0eadd; }

        .result-grid { display: flex; flex-direction: column; gap: 15px; }

        .card-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: stretch;
            transition: all 0.3s;
        }

        .card-row.locked .text-card {
            background-color: #f0f0f0; border-color: #ccc;
        }
        .card-row.locked textarea { background-color: #f0f0f0; color: #555; }

        .text-card {
            background: white; border: 2px solid #eee; border-radius: 15px;
            padding: 15px; position: relative; transition: 0.2s;
            display: flex; flex-direction: column;
        }
        .text-card.left-card { border-color: #ffe0e0; } 
        .text-card.right-card { border-color: #e0f2f1; background: #fdfffe; }

        .card-info {
            display: flex; justify-content: space-between; align-items: center; font-size: 12px;
            margin-bottom: 8px; color: #888;
        }
        .badge { padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .badge-num { background: #eee; color: #555; }
        .badge-len { background: #d4edda; color: #155724; }
        .badge-warn { background: #f8d7da; color: #721c24; }

        .btn-lock {
            background: white; border: 1px solid #ddd; border-radius: 15px;
            padding: 2px 8px; cursor: pointer; font-size: 11px; margin-left: 10px;
        }
        .card-row.locked .btn-lock { background: #555; color: white; border-color: #555; }

        textarea.card-editor {
            width: 100%; border: none; resize: none; outline: none;
            font-size: 16px; line-height: 1.6; font-family: 'Pretendard';
            background: transparent; height: auto; overflow: hidden; flex-grow: 1;
        }
        .right-editor:focus { background: #f0fffa; }

        .overflow-row { opacity: 0.7; }
        .overflow-row .text-card { border-style: dashed; background: #f5f5f5; }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; width: 400px; border-radius: 20px; }
        .dict-list { height: 300px; overflow-y: auto; border: 1px solid #eee; margin: 10px 0; padding: 10px; }
        .dict-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #f9f9f9; }
        
        @media (max-width: 800px) {
            .card-row { grid-template-columns: 1fr; gap: 10px; border-bottom: 2px dashed #eee; padding-bottom: 20px; }
            .dual-view-header { display: none; }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="#" class="logo">ğŸŒ¸ ì†ê¸° ë“€ì–¼ ë§ˆìŠ¤í„°</a>
    <div style="font-size: 0.9rem; color: #888;">ì„ ìƒë‹˜ì„ ìœ„í•œ í†µí•© ë„êµ¬</div>
</nav>

<div class="container">
    <div class="control-panel">
        <h3 style="margin-top:0;">ğŸ“ í…ìŠ¤íŠ¸ ì •ì œ ë° ë¶„í• </h3>
        <p style="font-size:13px; color:#666; margin-bottom:10px;">
            â€» <strong>ìµœì´ˆ ì‹¤í–‰</strong>ì€ ìœ„ ì…ë ¥ì°½ ë‚´ìš©ìœ¼ë¡œ, <strong>ì¬ë¶„ë°°</strong>ëŠ” ì•„ë˜ í¸ì§‘ëœ ë‚´ìš©(ì ê¸ˆ ìœ ì§€)ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
        </p>
        <div class="input-wrapper">
            <textarea id="rawInput" class="raw-input" placeholder="ì—¬ê¸°ì— ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        </div>

        <div class="settings-bar">
            <div class="setting-group">
                <i class="fa-solid fa-ruler-horizontal"></i> ì¤„ë‹¹ ê¸€ììˆ˜:
                <input type="number" id="lineLimit" value="270">
            </div>
            <div class="setting-group">
                <i class="fa-solid fa-hand"></i> ì´ ì œí•œ:
                <input type="number" id="totalLimit" value="1620">
            </div>
            
            <button class="btn btn-dict" onclick="openDictModal()">
                <i class="fa-solid fa-book"></i> ë‹¨ì–´ì¥
            </button>
            
            <button class="btn btn-reset" onclick="resetData()">
                <i class="fa-solid fa-trash-can"></i> ì´ˆê¸°í™”
            </button>

            <button class="btn btn-start" onclick="firstSplit()">
                <i class="fa-solid fa-play"></i> ìµœì´ˆ ì‹¤í–‰
            </button>

            <button class="btn btn-redo" onclick="reSplit()">
                <i class="fa-solid fa-rotate"></i> ì¬ë¶„ë°° (ì ê¸ˆìœ ì§€)
            </button>
            
            <button class="btn btn-copy" onclick="copyResult()">
                <i class="fa-solid fa-copy"></i> ìµœì¢… ë³µì‚¬
            </button>
        </div>
    </div>

    <div class="dual-view-header">
        <div class="col-header header-pink">ğŸ§¼ 1ì°¨ ì •ì œ (íŠ¹ìˆ˜ë¬¸ì ì œê±°/ìˆ˜ì •)</div>
        <div class="col-header header-mint">âœ¨ 2ì°¨ ë³€í™˜ (í•œê¸€Â·ìˆ«ì ë³€í™˜/ìˆ˜ì •)</div>
    </div>
    
    <div id="resultGrid" class="result-grid">
        <div style="text-align:center; padding:50px; color:#aaa;">
            'ìµœì´ˆ ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.
        </div>
    </div>
</div>

<div id="dictModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3>ğŸ“š ë³€í™˜ ë‹¨ì–´ì¥</h3>
            <span onclick="closeDictModal()" style="cursor:pointer; font-size:20px;">&times;</span>
        </div>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input type="text" id="newKey" placeholder="ì›ë³¸ (ì˜ˆ: Email)" style="flex:1; padding:8px;">
            <input type="text" id="newVal" placeholder="ë³€í™˜ (ì˜ˆ: ì´ë©”ì¼)" style="flex:1; padding:8px;">
            <button onclick="addWord()" style="background:var(--theme-mint); border:none; color:white; border-radius:5px; cursor:pointer;">ì¶”ê°€</button>
        </div>
        <div id="dictList" class="dict-list"></div>
    </div>
</div>

<script>
    let myDict = JSON.parse(localStorage.getItem("stenoDict")) || { 
        "OECD": "ì˜¤ì´ì‹œë””", "Email": "ì´ë©”ì¼", "email": "ì´ë©”ì¼" 
    };
    const alphabetMap = {'A':'ì—ì´','B':'ë¹„','C':'ì”¨','D':'ë””','E':'ì´','F':'ì—í”„','G':'ì§€','H':'ì—ì´ì¹˜','I':'ì•„ì´','J':'ì œì´','K':'ì¼€ì´','L':'ì—˜','M':'ì— ','N':'ì—”','O':'ì˜¤','P':'í”¼','Q':'í','R':'ì•Œ','S':'ì—ìŠ¤','T':'í‹°','U':'ìœ ','V':'ë¸Œì´','W':'ë”ë¸”ìœ ','X':'ì—‘ìŠ¤','Y':'ì™€ì´','Z':'ì œíŠ¸'};
    const digitMap = {'0':'ì˜','1':'ì¼','2':'ì´','3':'ì‚¼','4':'ì‚¬','5':'ì˜¤','6':'ìœ¡','7':'ì¹ ','8':'íŒ”','9':'êµ¬'};
    const CIRCLE_NUMS = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤'];

    function getPureLen(str) {
        if (!str) return 0;
        const matches = str.match(/[ê°€-í£ã„±-ã…ã…-ã…£a-zA-Z0-9]/g);
        return matches ? matches.length : 0;
    }

    function convertNumberToKorean(numStr) {
        const units = ['','ì‹­','ë°±','ì²œ'];
        const bigUnits = ['','ë§Œ','ì–µ','ì¡°','ê²½'];
        const numChar = ['ì˜','ì¼','ì´','ì‚¼','ì‚¬','ì˜¤','ìœ¡','ì¹ ','íŒ”','êµ¬'];
        let result = ''; 
        let num = numStr.replace(/,/g,''); 
        for(let i=0; i<num.length; i++) {
            let n = parseInt(num[i]);
            let digitPos = num.length - i - 1;
            let unitIndex = digitPos % 4;
            let bigUnitIndex = Math.floor(digitPos/4);
            if(n > 0) {
                if(n===1 && unitIndex>0) result += units[unitIndex];
                else result += numChar[n] + units[unitIndex];
            }
            if(unitIndex===0 && bigUnitIndex>0) {
                let chunkStart = Math.max(0, i-3);
                if(parseInt(num.substring(chunkStart, i+1)) > 0) result += bigUnits[bigUnitIndex];
            }
        }
        return result === '' ? 'ì˜' : result;
    }

    function cleanStage1(text) {
        text = text.replace(/\([^)]*\)/g, ""); 
        text = text.replace(/\n/g, " ");        
        text = text.replace(/[^a-zA-Z0-9ê°€-í£\s.,?%Â·&]/g, ""); 
        text = text.replace(/\s+/g, " ").trim(); 
        return text;
    }

    function convertStage2(text) {
        text = text.replace(/6\.25/g, "ìœ¡ì´ì˜¤");
        const sortedKeys = Object.keys(myDict).sort((a,b)=>b.length-a.length);
        for(const eng of sortedKeys) {
            text = text.replace(new RegExp(`\\b${eng}\\b`,'g'), myDict[eng]);
        }
        text = text.replace(/\b[A-Z]+\b/g, (m) => /[ê°€-í£]/.test(m)?m:[...m].map(c=>alphabetMap[c]||c).join(''));
        text = text.replace(/([0-9]+)(\.[0-9]+)?/g, (m, p1, p2) => {
            let korInt = convertNumberToKorean(p1);
            let korDec = p2 ? "ì " + [...p2.substring(1)].map(c=>digitMap[c]).join('') : "";
            return korInt + korDec;
        });
        return text;
    }

    /* --- ë²„íŠ¼ ê¸°ëŠ¥ --- */
    function resetData() {
        if(!confirm("ëª¨ë“  ì‘ì—… ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤. ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        document.getElementById('resultGrid').innerHTML = '<div style="text-align:center; padding:50px; color:#aaa;">ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.</div>';
    }

    function firstSplit() {
        const rawInput = document.getElementById('rawInput').value.trim();
        if (!rawInput) { alert("ì›ë³¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
        
        let finalBlocks = [];
        let buffer1 = cleanStage1(rawInput);
        
        processBuffer(buffer1, finalBlocks);
        renderGrid(finalBlocks);
    }

    function reSplit() {
        const grid = document.getElementById('resultGrid');
        const rows = grid.querySelectorAll('.card-row');
        
        if (rows.length === 0) {
            alert("ì¬ë¶„ë°°í•  ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤. 'ìµœì´ˆ ì‹¤í–‰'ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.");
            return;
        }

        let finalBlocks = [];
        let buffer1 = ""; 

        rows.forEach(row => {
            const s1 = row.querySelector('.left-editor').value;
            const isLocked = row.classList.contains('locked');

            if (isLocked) {
                if (buffer1.trim()) {
                    processBuffer(buffer1, finalBlocks);
                    buffer1 = "";
                }
                finalBlocks.push({ 
                    s1: s1, 
                    s2: convertStage2(s1), 
                    locked: true 
                });
            } else {
                buffer1 += " " + s1;
            }
        });

        if (buffer1.trim()) {
            processBuffer(buffer1, finalBlocks);
        }

        renderGrid(finalBlocks);
    }

    // [í•µì‹¬ ìˆ˜ì • 1] ì´ ì œí•œì´ ë„˜ìœ¼ë©´ ë¬´ì¡°ê±´ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸° (ìë¥´ê¸° ì¤‘ë‹¨)
    function processBuffer(textStage1, outputArray) {
        textStage1 = textStage1.replace(/\s+/g, " ").trim();
        const textStage2 = convertStage2(textStage1);
        
        const lineLimit = parseInt(document.getElementById('lineLimit').value);
        const totalLimit = parseInt(document.getElementById('totalLimit').value);
        
        // í˜„ì¬ê¹Œì§€ í™•ì •ëœ ê¸¸ì´ ê³„ì‚°
        let currentGlobalLen = 0;
        outputArray.forEach(block => {
            currentGlobalLen += getPureLen(block.s2);
        });

        const words1 = textStage1.split(' ');
        const words2 = textStage2.split(' ');
        
        let currentS1 = [];
        let currentS2 = [];
        let currentLen = 0;

        for (let i = 0; i < words1.length; i++) {
            const w1 = words1[i] || "";
            const w2 = words2[i] || ""; 
            const nextLen = getPureLen(w2);

            let shouldBreak = false;
            
            // "ì§€ê¸ˆê¹Œì§€ ë§Œë“  ê¸¸ì´"ê°€ ì´ë¯¸ ì œí•œì„ ë„˜ì—ˆìœ¼ë©´ -> ì ˆëŒ€ ìë¥´ì§€ ë§ˆë¼ (ë¬´ì¡°ê±´ í•©ì¹¨)
            if (currentGlobalLen >= totalLimit) {
                shouldBreak = false;
            } 
            // ì•„ì§ ì œí•œ ì•ˆ ë„˜ì—ˆìœ¼ë©´ -> 270ìì”© ìë¥´ê¸° ë¡œì§ ê°€ë™
            else {
                if (currentS2.length > 0) {
                    if (currentLen + nextLen > lineLimit + 3) {
                        shouldBreak = true;
                    } else if (currentLen + nextLen >= lineLimit - 3) {
                         const diffNow = Math.abs((currentLen + nextLen) - lineLimit);
                         const diffPrev = Math.abs(currentLen - lineLimit);
                         if (diffPrev < diffNow) shouldBreak = true;
                    }
                }
            }

            if (shouldBreak) {
                const s2Str = currentS2.join(' ');
                outputArray.push({
                    s1: currentS1.join(' '),
                    s2: s2Str,
                    locked: false
                });
                
                // ë¸”ë¡ ì¶”ê°€í–ˆìœ¼ë‹ˆ ì „ì²´ ê¸¸ì´ ì—…ë°ì´íŠ¸
                currentGlobalLen += getPureLen(s2Str);

                currentS1 = [w1]; currentS2 = [w2];
                currentLen = nextLen;
            } else {
                currentS1.push(w1); currentS2.push(w2);
                currentLen += nextLen;
            }
        }
        // ë‚¨ì€ê±° í„¸ê¸° (ë§ˆì§€ë§‰ ë¸”ë¡ ìƒì„±)
        if (currentS1.length > 0) {
            outputArray.push({
                s1: currentS1.join(' '),
                s2: currentS2.join(' '),
                locked: false
            });
        }
    }

    // [í•µì‹¬ ìˆ˜ì • 2] í™”ë©´ì— ê·¸ë¦´ ë•Œ, "ì‹œì‘ ì „"ì— ì´ë¯¸ ë„˜ì³ìˆì–´ì•¼ë§Œ íšŒìƒ‰ ì²˜ë¦¬
    function renderGrid(blocks) {
        const grid = document.getElementById('resultGrid');
        grid.innerHTML = "";
        const totalLimit = parseInt(document.getElementById('totalLimit').value);
        
        let accumulatedLen = 0;

        blocks.forEach((block, idx) => {
            const pureLen = getPureLen(block.s2);
            
            // "ì´ ë¸”ë¡ì„ ì‹œì‘í•˜ê¸° ì „ì˜ ëˆ„ì  ê¸¸ì´"ê°€ ì´ë¯¸ ì œí•œì„ ë„˜ì—ˆëŠ”ê°€?
            // ë„˜ì—ˆìœ¼ë©´ ì´ ë¸”ë¡ì€ 'ë²„ë¦¬ëŠ” ë¶€ë¶„' (íšŒìƒ‰)
            // ì•ˆ ë„˜ì—ˆìœ¼ë©´(ë”± ë§ê±°ë‚˜ ë¶€ì¡±í•˜ë©´) 'ìœ íš¨í•œ ë¶€ë¶„' (í°ìƒ‰)
            let isOverflow = accumulatedLen >= totalLimit;

            accumulatedLen += pureLen;
            
            const div = document.createElement('div');
            div.className = `card-row ${block.locked ? 'locked' : ''} ${isOverflow ? 'overflow-row' : ''}`;
            
            div.innerHTML = `
                <div class="text-card left-card">
                    <div class="card-info">
                        <span class="badge badge-num">#${idx + 1}</span>
                        <div style="display:flex; align-items:center;">
                            <span>1ì°¨ (ìˆ˜ì •ì‹œ 2ì°¨ìë™ë³€í™˜)</span>
                            <button class="btn-lock" onclick="toggleLock(this)">
                                ${block.locked ? '<i class="fa-solid fa-lock"></i>' : '<i class="fa-solid fa-lock-open"></i>'}
                            </button>
                        </div>
                    </div>
                    <textarea class="card-editor left-editor" oninput="syncLeftToRight(this)">${block.s1}</textarea>
                </div>

                <div class="text-card right-card">
                    <div class="card-info">
                        <span>2ì°¨ (ìˆ˜ì •ì‹œ 1ì°¨ë™ê¸°í™”)</span>
                        <span class="badge ${Math.abs(pureLen - document.getElementById('lineLimit').value) <= 3 ? 'badge-len' : 'badge-warn'}">ìˆœìˆ˜ ${pureLen}ì</span>
                    </div>
                    <textarea class="card-editor right-editor" oninput="syncRightToLeft(this)">${block.s2}</textarea>
                </div>
            `;
            grid.appendChild(div);
            autoResize(div.querySelector('.left-editor'));
            autoResize(div.querySelector('.right-editor'));
        });
    }

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function toggleLock(btn) {
        const row = btn.closest('.card-row');
        row.classList.toggle('locked');
        const isLocked = row.classList.contains('locked');
        btn.innerHTML = isLocked ? '<i class="fa-solid fa-lock"></i>' : '<i class="fa-solid fa-lock-open"></i>';
    }

    window.syncLeftToRight = function(leftTa) {
        autoResize(leftTa);
        const row = leftTa.closest('.card-row');
        const rightTa = row.querySelector('.right-editor');
        const badge = row.querySelector('.badge');
        const newS1 = leftTa.value; 
        const newS2 = convertStage2(newS1);
        rightTa.value = newS2;
        autoResize(rightTa);
        updateBadge(badge, newS2);
    }

    window.syncRightToLeft = function(rightTa) {
        autoResize(rightTa);
        const row = rightTa.closest('.card-row');
        const leftTa = row.querySelector('.left-editor');
        const badge = row.querySelector('.badge');
        const val = rightTa.value;
        leftTa.value = val;
        autoResize(leftTa);
        updateBadge(badge, val);
    }

    function updateBadge(badge, text) {
        const len = getPureLen(text);
        const target = parseInt(document.getElementById('lineLimit').value);
        badge.innerText = `ìˆœìˆ˜ ${len}ì`;
        badge.className = `badge ${Math.abs(len - target) <= 3 ? 'badge-len' : 'badge-warn'}`;
    }

    function copyResult() {
        const rows = Array.from(document.querySelectorAll('.card-row'));
        const validRows = rows.filter(r => !r.classList.contains('overflow-row'));
        if(validRows.length === 0) { alert("ë³µì‚¬í•  ìœ íš¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        let fullText = "";
        const totalValid = validRows.length;

        validRows.forEach((row, idx) => {
            const s1 = row.querySelector('.left-editor').value; 
            const s2 = row.querySelector('.right-editor').value; 
            const len = getPureLen(s2);
            const reverseIdx = totalValid - 1 - idx; 
            let suffix = "";
            if (reverseIdx >= 0 && reverseIdx < 5) {
                const symbol = CIRCLE_NUMS[4 - reverseIdx]; 
                suffix = `\n${symbol}-${len}`;
            }
            fullText += s1 + suffix + "\n\n";
        });

        navigator.clipboard.writeText(fullText).then(() => {
            alert("ë³µì‚¬ ì™„ë£Œ! (ë§ˆì§€ë§‰ 5ê°œ ë‹¨ë½ ê¼¬ë¦¬í‘œ í¬í•¨)");
        });
    }

    function openDictModal() { document.getElementById('dictModal').style.display = "block"; renderDict(); }
    function closeDictModal() { document.getElementById('dictModal').style.display = "none"; }
    function addWord() {
        const k = document.getElementById('newKey').value.trim();
        const v = document.getElementById('newVal').value.trim();
        if(k && v) {
            myDict[k] = v;
            localStorage.setItem("stenoDict", JSON.stringify(myDict));
            document.getElementById('newKey').value=""; document.getElementById('newVal').value="";
            renderDict();
        }
    }
    function renderDict() {
        const list = document.getElementById('dictList');
        list.innerHTML = "";
        Object.keys(myDict).forEach(key => {
            const div = document.createElement('div');
            div.className = 'dict-item';
            div.innerHTML = `<span>${key} â†’ ${myDict[key]}</span> <button onclick="delWord('${key}')" style="border:none;background:none;color:red;cursor:pointer;">ì‚­ì œ</button>`;
            list.appendChild(div);
        });
    }
    window.delWord = function(key) { delete myDict[key]; localStorage.setItem("stenoDict", JSON.stringify(myDict)); renderDict(); }
    window.onclick = function(e) { if(e.target == document.getElementById('dictModal')) closeDictModal(); }
</script>
</body>
</html>
